---
import '../styles/global.css';

const { title = 'Mimoto', description = '' } = Astro.props;
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/png" sizes="16x16" href="/icono-pestana.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/icono-pestana.png" />
    <link rel="icon" type="image/png" sizes="64x64" href="/icono-pestana.png" />
    <link rel="icon" type="image/png" sizes="128x128" href="/icono-pestana.png" />
    <link rel="shortcut icon" type="image/png" href="/icono-pestana.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/icono-pestana.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="/icono-pestana.png" />
    <link rel="apple-touch-icon" sizes="144x144" href="/icono-pestana.png" />
    <link rel="apple-touch-icon" sizes="120x120" href="/icono-pestana.png" />
    <link rel="apple-touch-icon" sizes="114x114" href="/icono-pestana.png" />
    <link rel="apple-touch-icon" sizes="76x76" href="/icono-pestana.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="/icono-pestana.png" />
    <link rel="apple-touch-icon" sizes="60x60" href="/icono-pestana.png" />
    <link rel="apple-touch-icon" sizes="57x57" href="/icono-pestana.png" />
    <title>{title}</title>
    {description && <meta name="description" content={description} />}
    <script is:inline>
      // Inicializar tema ANTES de renderizar para evitar flash
      (function() {
        try {
          const theme = localStorage.getItem('theme') || 'light';
          const html = document.documentElement;
          if (theme === 'dark') {
            html.classList.add('dark');
          } else {
            html.classList.remove('dark');
          }
        } catch (e) {
          document.documentElement.classList.remove('dark');
        }
      })();
    </script>
    <style>
      /* Forzar aplicaci√≥n de dark mode con !important */
      html.dark body {
        background-color: transparent !important;
        background-image: url('/backgrund.jpg') !important;
        background-size: cover !important;
        background-position: center !important;
        background-attachment: fixed !important;
        color: #FFFFFF !important;
      }
      
      html.dark body::before {
        content: '';
        position: fixed;
        inset: 0;
        background: linear-gradient(to bottom right, 
          rgba(0, 0, 0, 0.75) 0%,
          rgba(0, 0, 0, 0.70) 25%,
          rgba(0, 0, 0, 0.72) 50%,
          rgba(0, 0, 0, 0.70) 75%,
          rgba(0, 0, 0, 0.75) 100%
        );
        pointer-events: none;
        z-index: -1;
      }
      
      /* Overlay adicional sutil para oscurecer ligeramente el centro */
      html.dark body::after {
        content: '';
        position: fixed;
        inset: 0;
        background: radial-gradient(ellipse at center, rgba(0, 0, 0, 0.25) 0%, rgba(0, 0, 0, 0.15) 40%, transparent 70%);
        pointer-events: none;
        z-index: -1;
      }
      
      html:not(.dark) body {
        background-color: #FFFFFF !important;
        color: #1A1A1A !important;
      }
      
      /* Animaciones para tooltip */
      @keyframes fade-in {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      @keyframes fade-out {
        from {
          opacity: 1;
          transform: translateY(0);
        }
        to {
          opacity: 0;
          transform: translateY(-10px);
        }
      }
      
      .animate-fade-in {
        animation: fade-in 0.3s ease-out forwards;
      }
      
      .animate-fade-out {
        animation: fade-out 0.3s ease-out forwards;
      }
      
      /* Estilos para placeholder de productos en banner */
      .banner-product-placeholder {
        transition: opacity 0.3s ease-in-out;
      }
      
      .banner-product-placeholder img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
      }
    </style>
  </head>
  <body class="min-h-screen flex flex-col text-ktm-light-text dark:text-ktm-text transition-colors duration-300" id="main-body">
    <!-- Franjas diagonales decorativas en el fondo -->
    <div class="fixed inset-0 diagonal-stripes-dark opacity-20 dark:opacity-20 opacity-5 pointer-events-none z-0"></div>
    
    <header id="main-header" class="relative border-b-2 border-ktm-light-border dark:border-ktm-border backdrop-blur-md sticky top-0 z-40 shadow-lg bg-ktm-light-surface dark:bg-gradient-to-r dark:from-[#0F0F0F] dark:via-[#2A1A1A] dark:via-[#4A1A1A] dark:via-[#7F1D1D] dark:via-[#991B1B] dark:via-[#B91C1C] dark:via-[#DC2626] dark:via-[#B91C1C] dark:via-[#991B1B] dark:via-[#7F1D1D] dark:via-[#4A1A1A] dark:via-[#2A1A1A] dark:to-[#0F0F0F] transition-colors duration-300">
      <nav class="max-w-7xl mx-auto px-4 md:px-6 h-16 md:h-20 flex items-center justify-between">
        <a href="/" class="flex items-center gap-3 relative z-10">
          <div class="absolute -left-4 -top-2 -right-4 -bottom-2 bg-ktm-accent/30 blur-2xl -z-10 rounded-full"></div>
          <div class="flex items-center gap-2">
            <img id="main-logo" src="/logo.png" alt="Mimoto" class="object-contain object-left drop-shadow-2xl filter brightness-110 transition-opacity duration-300" />
              <div class="flex flex-col items-center gap-0.5 border-l border-ktm-light-border/30 dark:border-ktm-border/30 pl-2 ml-2">
                <img src="/KTM-logo.png" alt="KTM" class="h-6 md:h-8 w-auto object-contain opacity-90 hover:opacity-100 transition-opacity drop-shadow-md" />
                <div class="flex flex-col items-center leading-none">
                  <span class="text-[6px] md:text-[8px] font-black uppercase tracking-[0.15em] text-ktm-accent dark:text-white dark:text-opacity-90" style="font-family: 'Arial Black', 'Helvetica Neue', 'Arial', sans-serif; text-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                    servicio tecnico
                  </span>
                  <span class="text-[6px] md:text-[8px] font-black uppercase tracking-[0.15em] text-ktm-accent dark:text-white dark:text-opacity-90" style="font-family: 'Arial Black', 'Helvetica Neue', 'Arial', sans-serif; text-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                    autorizado
                  </span>
                </div>
              </div>
          </div>
        </a>
        <div id="nav-links" class="hidden md:flex items-center gap-6 text-sm font-medium">
          <a href="/servicios" class="nav-link text-ktm-light-text dark:text-white hover:text-ktm-accent transition-colors font-semibold">Servicios</a>
          <a href="/tienda" class="nav-link text-ktm-light-text dark:text-white hover:text-ktm-accent transition-colors font-semibold">Accesorios y Repuestos</a>
          <a href="/motos-usadas" class="nav-link text-ktm-light-text dark:text-white hover:text-ktm-accent transition-colors font-semibold">Motos usadas</a>
          <a href="/sobre-nosotros" class="nav-link text-ktm-light-text dark:text-white hover:text-ktm-accent transition-colors font-semibold">Sobre Nosotros</a>
          <div class="flex items-center gap-3">
            <div id="auth-status" class="flex items-center gap-2">
              <a href="/login" id="auth-link" class="nav-link text-ktm-light-text/70 dark:text-white/80 hover:text-ktm-accent transition-colors">Iniciar sesi√≥n</a>
            </div>
            <!-- Bot√≥n de toggle de tema - Switch visual -->
            <div class="relative">
              <button
                type="button"
                id="theme-toggle"
                class="relative inline-flex items-center w-14 h-7 rounded-full bg-ktm-light-border dark:bg-ktm-border transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-ktm-accent focus:ring-offset-2"
                aria-label="Cambiar tema"
                role="switch"
                aria-checked="true"
              >
              <span
                id="theme-toggle-slider"
                class="absolute left-1 top-1 w-5 h-5 bg-white dark:bg-ktm-accent rounded-full shadow-md transform transition-transform duration-500 ease-in-out translate-x-0 dark:translate-x-7 z-10"
              ></span>
              <!-- Icono Sol (visible en light mode, a la derecha) -->
              <span id="theme-icon" class="absolute right-1.5 top-1/2 -translate-y-1/2 transition-opacity duration-300 z-0" style="opacity: 1;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-black">
                  <circle cx="12" cy="12" r="5"></circle>
                  <line x1="12" y1="1" x2="12" y2="3"></line>
                  <line x1="12" y1="21" x2="12" y2="23"></line>
                  <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                  <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                  <line x1="1" y1="12" x2="3" y2="12"></line>
                  <line x1="21" y1="12" x2="23" y2="12"></line>
                  <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                  <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
              </span>
              <!-- Icono Luna (visible en dark mode, a la izquierda) -->
              <span id="theme-icon-dark" class="absolute left-1.5 top-1/2 -translate-y-1/2 transition-opacity duration-300 z-0" style="opacity: 0;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white">
                  <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
              </span>
              </button>
              <!-- Tooltip informativo -->
              <div
                id="theme-tooltip"
                class="hidden absolute right-0 top-full mt-2 w-64 p-3 bg-ktm-accent text-white text-sm rounded-lg shadow-xl z-50 pointer-events-none"
                style="transform: translateX(calc(100% - 3.5rem));"
              >
                <p class="font-semibold mb-1">üí° Modo Oscuro Disponible</p>
                <p class="text-xs opacity-90">Puedes cambiar a modo oscuro haciendo clic en este bot√≥n</p>
                <div class="absolute -top-2 right-6 w-0 h-0 border-l-8 border-r-8 border-b-8 border-transparent border-b-ktm-accent"></div>
              </div>
            </div>
            <button
              type="button"
              class="relative inline-flex items-center justify-center w-10 h-10 rounded-full bg-ktm-accent hover:bg-ktm-accentSoft text-black transition-colors shadow-lg"
              data-cart-open
            >
              üõí
            </button>
          </div>
        </div>
        <!-- Men√∫ m√≥vil -->
        <div class="md:hidden flex items-center gap-2">
          <button
            type="button"
            id="theme-toggle-mobile"
            class="relative inline-flex items-center w-14 h-7 rounded-full bg-ktm-light-border dark:bg-ktm-border transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-ktm-accent focus:ring-offset-2"
            aria-label="Cambiar tema"
            role="switch"
            aria-checked="true"
          >
            <span
              id="theme-toggle-slider-mobile"
              class="absolute left-1 top-1 w-5 h-5 bg-white dark:bg-ktm-accent rounded-full shadow-md transform transition-transform duration-500 ease-in-out translate-x-0 dark:translate-x-7 z-10"
            ></span>
            <!-- Icono Sol (visible en light mode, a la derecha) -->
            <span id="theme-icon-mobile" class="absolute right-1.5 top-1/2 -translate-y-1/2 transition-opacity duration-300 z-0" style="opacity: 1;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-black">
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
              </svg>
            </span>
            <!-- Icono Luna (visible en dark mode, a la izquierda) -->
            <span id="theme-icon-dark-mobile" class="absolute left-1.5 top-1/2 -translate-y-1/2 transition-opacity duration-300 z-0" style="opacity: 0;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
              </svg>
            </span>
          </button>
          <button id="mobile-menu-btn" class="w-10 h-10 flex items-center justify-center text-ktm-light-text dark:text-white">
            ‚ò∞
          </button>
        </div>
      </nav>
      <!-- Men√∫ m√≥vil desplegable -->
      <div id="mobile-menu" class="hidden md:hidden bg-ktm-light-surfaceAlt/80 dark:bg-ktm-surfaceAlt/80 backdrop-blur-md border-t border-ktm-light-border/20 dark:border-ktm-border/20">
        <div class="px-4 py-4 space-y-3">
          <a href="/servicios" class="block text-ktm-light-text dark:text-white hover:text-ktm-accent transition-colors font-semibold">Servicios</a>
          <a href="/tienda" class="block text-ktm-light-text dark:text-white hover:text-ktm-accent transition-colors font-semibold">Accesorios y Repuestos</a>
          <a href="/motos-usadas" class="block text-ktm-light-text dark:text-white hover:text-ktm-accent transition-colors font-semibold">Motos usadas</a>
          <a href="/sobre-nosotros" class="block text-ktm-light-text dark:text-white hover:text-ktm-accent transition-colors font-semibold">Sobre Nosotros</a>
            <div id="auth-status-mobile" class="pt-3 border-t border-ktm-light-border/20 dark:border-ktm-border/20">
            <a href="/login" class="block text-ktm-light-text/70 dark:text-white/80 hover:text-ktm-accent transition-colors">Iniciar sesi√≥n</a>
          </div>
        </div>
      </div>
    </header>

    <main class="relative flex-1 z-10">
      <slot />
    </main>

    <footer class="relative border-t border-ktm-light-border/20 dark:border-ktm-border/20 bg-ktm-light-surface/80 dark:bg-ktm-surface/80 backdrop-blur-md mt-12">
      <div class="max-w-7xl mx-auto px-4 md:px-6 py-8">
        <div class="flex flex-col md:flex-row items-center md:items-start justify-between gap-6 mb-6">
          <div class="flex-shrink-0 flex flex-col items-center md:items-start gap-3">
            <div class="flex items-center gap-2">
              <img
                id="footer-logo"
                src="/logo.png"
                alt="Mimoto Logo"
                class="w-32 md:w-40 h-auto"
              />
              <div class="flex flex-col items-center gap-0.5 border-l border-ktm-light-border/30 dark:border-ktm-border/30 pl-2 ml-2">
                <img src="/KTM-logo.png" alt="KTM" class="h-8 md:h-10 w-auto object-contain opacity-90 drop-shadow-md" />
                <div class="flex flex-col items-center leading-none">
                  <span class="text-[7px] md:text-[9px] font-black uppercase tracking-[0.15em] text-ktm-accent dark:text-white dark:text-opacity-90" style="font-family: 'Arial Black', 'Helvetica Neue', 'Arial', sans-serif; text-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                    servicio tecnico
                  </span>
                  <span class="text-[7px] md:text-[9px] font-black uppercase tracking-[0.15em] text-ktm-accent dark:text-white dark:text-opacity-90" style="font-family: 'Arial Black', 'Helvetica Neue', 'Arial', sans-serif; text-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                    autorizado
                  </span>
                </div>
              </div>
            </div>
          </div>
          <div class="flex flex-col gap-4 text-sm text-ktm-light-textMuted dark:text-ktm-textMuted text-center md:text-left">
            <p class="font-semibold text-ktm-light-text dark:text-ktm-text">
              Desde 1995, Avda. Pdte. Sebast√≠an Pi√±era E. 785, 7570469 Las Condes, Regi√≥n Metropolitana, +56 2 22049215, lunes a viernes de 9:30 a 14:00 y 15:00 a 18:30
            </p>
            <p>¬© 2024 MIMOTO - Claudio Nilo</p>
          </div>
        </div>
        <div class="pt-4 border-t border-ktm-light-border/20 dark:border-ktm-border/20 text-xs text-ktm-light-textMuted dark:text-ktm-textMuted text-center">
          <p>
            Dise√±ado por{' '}
            <a
              href="https://wa.me/56962614851"
              target="_blank"
              rel="noopener noreferrer"
              class="hover:text-ktm-accent transition-colors"
            >
              Jonathan Guarirapa
            </a>
            {' ‚Ä¢ '}
            <a
              href="https://github.com/jonacrd"
              target="_blank"
              rel="noopener noreferrer"
              class="hover:text-ktm-accent transition-colors"
            >
              GitHub
            </a>
            {' ‚Ä¢ '}
            <a
              href="https://portfolio-site-blush-one.vercel.app/"
              target="_blank"
              rel="noopener noreferrer"
              class="hover:text-ktm-accent transition-colors"
            >
              Portfolio
            </a>
          </p>
        </div>
      </div>
    </footer>

    <!-- Bot√≥n flotante de WhatsApp -->
    <a
      href={import.meta.env.PUBLIC_WHATSAPP_URL || '#'}
      class="fixed bottom-6 right-4 md:right-6 inline-flex items-center gap-2 px-6 py-4 rounded-full bg-[#25D366] text-white font-bold shadow-2xl hover:bg-[#20BA5A] hover:scale-105 transition-all z-50"
      target="_blank"
      rel="noopener noreferrer"
    >
      <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
      </svg>
      <span class="hidden sm:inline">WhatsApp</span>
    </a>

    <!-- Sidebar del carrito -->
    <aside
      id="cart-sidebar"
      class="fixed inset-y-0 right-0 w-full md:w-96 bg-ktm-light-surface/95 dark:bg-ktm-surface/95 backdrop-blur-md border-l border-ktm-light-border/20 dark:border-ktm-border/20 transform translate-x-full transition-transform z-50 flex flex-col shadow-2xl"
    >
      <div class="p-4 flex items-center justify-between border-b border-ktm-light-border/20 dark:border-ktm-border/20 bg-ktm-light-surfaceAlt/80 dark:bg-ktm-surfaceAlt/80 backdrop-blur-sm text-ktm-light-text dark:text-ktm-text">
        <h2 class="font-bold text-lg">Carrito de Compras</h2>
        <button type="button" data-cart-close class="text-ktm-light-text dark:text-ktm-text hover:text-ktm-light-textMuted dark:hover:text-ktm-textMuted text-2xl font-bold">‚úï</button>
      </div>
      <div class="p-4 space-y-3 text-sm overflow-y-auto flex-1 text-ktm-light-textSecondary dark:text-ktm-textSecondary" id="cart-items"></div>
      <div class="p-4 border-t border-ktm-light-border/20 dark:border-ktm-border/20 bg-ktm-light-surfaceAlt/80 dark:bg-ktm-surfaceAlt/80 backdrop-blur-sm flex items-center justify-between text-base font-bold">
        <span class="text-ktm-light-text dark:text-ktm-text">Total</span>
        <span id="cart-total" class="text-ktm-accent text-2xl">$0</span>
      </div>
      <div class="p-4 border-t border-ktm-light-border/20 dark:border-ktm-border/20">
        <a
          href="/checkout"
          class="w-full inline-flex items-center justify-center px-6 py-4 rounded-lg bg-ktm-accent text-black font-bold hover:bg-ktm-accentSoft transition-colors text-base shadow-lg"
        >
          Finalizar compra
        </a>
      </div>
    </aside>

    <!-- Fondo oscuro detr√°s del carrito -->
    <div
      id="cart-backdrop"
      class="fixed inset-0 bg-ktm-light-bg/50 dark:bg-ktm-bg/50 opacity-0 pointer-events-none transition-opacity z-40"
    ></div>

    <!-- Script para men√∫ m√≥vil, toggle de tema y detecci√≥n de √°reas oscuras -->
    <script>
      // Toggle de tema - FUNCI√ìN PRINCIPAL
      function initTheme() {
        try {
          const theme = localStorage.getItem('theme') || 'light';
          const html = document.documentElement;
          const body = document.body;
          
          console.log('üîß Inicializando tema:', theme);
          
          if (theme === 'dark') {
            html.classList.add('dark');
            // Aplicar background con imagen en modo dark
            body.style.cssText += 'background-color: transparent !important; background-image: url(\'/backgrund.jpg\') !important; background-size: cover !important; background-position: center !important; background-attachment: fixed !important; color: #FFFFFF !important;';
          } else {
            html.classList.remove('dark');
            // Aplicar fondo blanco en modo light
            body.style.cssText += 'background-color: #FFFFFF !important; background-image: none !important; color: #1A1A1A !important;';
          }
          
          console.log('‚úÖ HTML classes despu√©s de init:', html.className);
          console.log('‚úÖ Tiene clase dark?', html.classList.contains('dark'));
          
          updateThemeIcon();
          updateLogo();
          showThemeTooltip();
          
          // Forzar re-renderizado
          setTimeout(() => {
            checkNavbarColor();
          }, 50);
        } catch (e) {
          console.error('‚ùå Error inicializando tema:', e);
          document.documentElement.classList.remove('dark');
        }
      }
      
      function showThemeTooltip() {
        const theme = localStorage.getItem('theme') || 'light';
        if (theme === 'light') {
          // Mostrar tooltip solo si no se ha mostrado antes o si pas√≥ mucho tiempo
          const lastShown = localStorage.getItem('theme-tooltip-shown');
          const now = Date.now();
          const oneDay = 24 * 60 * 60 * 1000; // 24 horas
          
          if (!lastShown || (now - parseInt(lastShown)) > oneDay) {
            setTimeout(() => {
              const tooltip = document.getElementById('theme-tooltip');
              if (tooltip) {
                tooltip.classList.remove('hidden');
                tooltip.classList.add('animate-fade-in');
                
                // Ocultar despu√©s de 5 segundos
                setTimeout(() => {
                  tooltip.classList.add('animate-fade-out');
                  setTimeout(() => {
                    tooltip.classList.add('hidden');
                    tooltip.classList.remove('animate-fade-in', 'animate-fade-out');
                  }, 300);
                }, 5000);
                
                // Guardar que se mostr√≥
                localStorage.setItem('theme-tooltip-shown', now.toString());
              }
            }, 1000);
          }
        }
      }

      function toggleTheme() {
        try {
          const html = document.documentElement;
          const body = document.body;
          const isDark = html.classList.contains('dark');
          
          console.log('üîÑ Toggle tema - Estado ANTES:', isDark ? 'dark' : 'light');
          
          // Cambiar la clase dark en el HTML - ESTO ES LO M√ÅS IMPORTANTE
          if (isDark) {
            html.classList.remove('dark');
            localStorage.setItem('theme', 'light');
            // En light mode: fondo blanco s√≥lido
            body.style.cssText += 'background-color: #FFFFFF !important; background-image: none !important; color: #1A1A1A !important;';
            const main = document.querySelector('main');
            if (main) {
              main.style.cssText += 'background-color: #FFFFFF !important; color: #1A1A1A !important;';
            }
            console.log('‚úÖ LIGHT MODE activado');
          } else {
            html.classList.add('dark');
            localStorage.setItem('theme', 'dark');
            // En dark mode: dejar que el CSS maneje el background con la imagen
            // Solo aplicar color de texto, NO background-color para que se vea la imagen
            body.style.cssText += 'background-color: transparent !important; background-image: url(\'/backgrund.jpg\') !important; background-size: cover !important; background-position: center !important; background-attachment: fixed !important; color: #FFFFFF !important;';
            const main = document.querySelector('main');
            if (main) {
              main.style.cssText += 'background-color: transparent !important; color: #FFFFFF !important;';
            }
            console.log('‚úÖ DARK MODE activado con background');
          }
          
          // Verificar inmediatamente
          const newIsDark = html.classList.contains('dark');
          console.log('‚úÖ Verificaci√≥n - HTML tiene dark?', newIsDark);
          console.log('‚úÖ HTML classes:', html.className);
          
          // Verificar estilos del body ANTES y DESPU√âS
          const bodyStylesBefore = window.getComputedStyle(body);
          console.log('‚úÖ Body background ANTES:', bodyStylesBefore.backgroundColor);
          
          // Forzar un reflow
          void body.offsetHeight;
          
          const bodyStylesAfter = window.getComputedStyle(body);
          console.log('‚úÖ Body background DESPU√âS:', bodyStylesAfter.backgroundColor);
          console.log('‚úÖ Body color DESPU√âS:', bodyStylesAfter.color);
          
          // Actualizar iconos y logo
          updateThemeIcon();
          updateLogo();
          
          // Ocultar tooltip si cambia a dark mode
          if (!isDark) {
            const tooltip = document.getElementById('theme-tooltip');
            if (tooltip) {
              tooltip.classList.add('hidden');
            }
          }
          
          // Forzar actualizaci√≥n del navbar
          setTimeout(() => {
            checkNavbarColor();
          }, 50);
          
          // Disparar evento
          window.dispatchEvent(new CustomEvent('themechange', { 
            detail: { theme: isDark ? 'light' : 'dark' } 
          }));
          
        } catch (e) {
          console.error('‚ùå Error cambiando tema:', e);
        }
      }

      function updateLogo() {
        const logo = document.getElementById('main-logo');
        const footerLogo = document.getElementById('footer-logo');
        const isDark = document.documentElement.classList.contains('dark');
        
        if (logo) {
          // Cambiar la imagen
          if (isDark) {
            logo.src = '/logo-dark.png';
            // Logo dark: tama√±o original (w-48 md:w-60 h-auto) - m√°s grande
            logo.className = 'w-48 md:w-60 h-auto object-contain object-left drop-shadow-2xl filter brightness-110 transition-opacity duration-300';
            logo.style.width = '';
            logo.style.height = '';
            logo.style.maxWidth = '';
            logo.style.maxHeight = '';
          } else {
            logo.src = '/logo.png';
            // Logo normal: un poco m√°s grande (w-40 md:w-48 h-auto)
            logo.className = 'w-40 md:w-48 h-auto object-contain object-left drop-shadow-2xl filter brightness-110 transition-opacity duration-300';
            logo.style.width = '';
            logo.style.height = '';
            logo.style.maxWidth = '';
            logo.style.maxHeight = '';
          }
        }
        
        // Actualizar logo del footer
        if (footerLogo) {
          if (isDark) {
            footerLogo.src = '/logo-dark.png';
            footerLogo.className = 'w-32 md:w-40 h-auto object-contain transition-opacity duration-300';
          } else {
            footerLogo.src = '/logo.png';
            footerLogo.className = 'w-32 md:w-40 h-auto object-contain transition-opacity duration-300';
          }
        }
      }

      function updateThemeIcon() {
        const isDark = document.documentElement.classList.contains('dark');
        const toggle = document.getElementById('theme-toggle');
        const toggleMobile = document.getElementById('theme-toggle-mobile');
        const slider = document.getElementById('theme-toggle-slider');
        const sliderMobile = document.getElementById('theme-toggle-slider-mobile');
        const iconSun = document.getElementById('theme-icon');
        const iconMoon = document.getElementById('theme-icon-dark');
        const iconSunMobile = document.getElementById('theme-icon-mobile');
        const iconMoonMobile = document.getElementById('theme-icon-dark-mobile');
        
        if (toggle) {
          toggle.setAttribute('aria-checked', isDark ? 'true' : 'false');
        }
        if (toggleMobile) {
          toggleMobile.setAttribute('aria-checked', isDark ? 'true' : 'false');
        }
        
        // Actualizar posici√≥n del slider manualmente para asegurar que funcione con animaci√≥n suave
        if (slider) {
          if (isDark) {
            slider.style.transform = 'translateX(1.75rem)'; // 7 * 0.25rem = 1.75rem
            slider.style.transition = 'transform 0.5s ease-in-out';
          } else {
            slider.style.transform = 'translateX(0)';
            slider.style.transition = 'transform 0.5s ease-in-out';
          }
        }
        if (sliderMobile) {
          if (isDark) {
            sliderMobile.style.transform = 'translateX(1.75rem)';
            sliderMobile.style.transition = 'transform 0.5s ease-in-out';
          } else {
            sliderMobile.style.transform = 'translateX(0)';
            sliderMobile.style.transition = 'transform 0.5s ease-in-out';
          }
        }
        
        // Actualizar opacidad de los iconos manualmente
        if (iconSun) {
          if (isDark) {
            iconSun.style.opacity = '0';
            iconSun.style.pointerEvents = 'none';
          } else {
            iconSun.style.opacity = '1';
            iconSun.style.pointerEvents = 'auto';
          }
        }
        if (iconMoon) {
          if (isDark) {
            iconMoon.style.opacity = '1';
            iconMoon.style.pointerEvents = 'auto';
          } else {
            iconMoon.style.opacity = '0';
            iconMoon.style.pointerEvents = 'none';
          }
        }
        if (iconSunMobile) {
          if (isDark) {
            iconSunMobile.style.opacity = '0';
            iconSunMobile.style.pointerEvents = 'none';
          } else {
            iconSunMobile.style.opacity = '1';
            iconSunMobile.style.pointerEvents = 'auto';
          }
        }
        if (iconMoonMobile) {
          if (isDark) {
            iconMoonMobile.style.opacity = '1';
            iconMoonMobile.style.pointerEvents = 'auto';
          } else {
            iconMoonMobile.style.opacity = '0';
            iconMoonMobile.style.pointerEvents = 'none';
          }
        }
        
        console.log('‚úÖ Iconos actualizados - Dark mode:', isDark);
      }

      // Detectar √°reas oscuras y cambiar color del navbar
      function checkNavbarColor() {
        try {
          const header = document.getElementById('main-header');
          const navLinks = document.querySelectorAll('.nav-link');
          const authLink = document.getElementById('auth-link');
          const mobileMenuBtn = document.getElementById('mobile-menu-btn');
          
          if (!header) {
            console.warn('Header no encontrado');
            return;
          }

          const isDarkMode = document.documentElement.classList.contains('dark');
          
          // En dark mode, NO manipular clases - dejar que Tailwind maneje con dark:
          if (isDarkMode) {
            // Solo limpiar clases de light mode que puedan interferir
            navLinks.forEach(link => {
              link.classList.remove('text-black', 'font-bold', 'text-ktm-light-text', 'text-ktm-light-text/70');
            });
            if (authLink) {
              authLink.classList.remove('text-black', 'font-bold', 'text-ktm-light-text', 'text-ktm-light-text/70');
            }
            if (mobileMenuBtn) {
              mobileMenuBtn.classList.remove('text-black', 'text-ktm-light-text');
            }
            return;
          }

          // En light mode, detectar si est√° sobre √°rea oscura
          const headerRect = header.getBoundingClientRect();
          const headerBottom = headerRect.bottom;
          const headerTop = headerRect.top;
          
          // Buscar elementos con clase dark-section
          const darkSections = document.querySelectorAll('.dark-section');
          let isOverDark = false;

          darkSections.forEach(section => {
            const rect = section.getBoundingClientRect();
            // Si la secci√≥n oscura est√° visible y el header est√° sobre ella
            if (rect.top <= headerBottom && rect.bottom >= headerTop) {
              isOverDark = true;
            }
          });

          // Tambi√©n verificar el hero banner (primer section)
          if (!isOverDark) {
            const heroSection = document.querySelector('section:first-of-type');
            if (heroSection) {
              const heroRect = heroSection.getBoundingClientRect();
              const heroBg = window.getComputedStyle(heroSection).backgroundImage;
              
              // Si el hero tiene imagen de fondo o est√° visible debajo del header
              if ((heroBg && heroBg !== 'none' && heroBg !== 'initial') || 
                  (heroRect.top <= headerBottom && heroRect.bottom >= headerTop)) {
                isOverDark = true;
              }
            }
          }

          // En light mode: si est√° sobre √°rea oscura, usar texto NEGRO para legibilidad
          if (isOverDark) {
            header.classList.add('nav-over-dark');
            navLinks.forEach(link => {
              link.classList.remove('text-ktm-light-text', 'text-ktm-light-text/70', 'text-white');
              link.classList.add('text-black', 'font-bold');
            });
            if (authLink) {
              authLink.classList.remove('text-ktm-light-text', 'text-ktm-light-text/70', 'text-white');
              authLink.classList.add('text-black', 'font-bold');
            }
            if (mobileMenuBtn) {
              mobileMenuBtn.classList.remove('text-ktm-light-text', 'text-white');
              mobileMenuBtn.classList.add('text-black');
            }
          } else {
            header.classList.remove('nav-over-dark');
            navLinks.forEach(link => {
              link.classList.remove('text-white', 'text-black', 'font-bold');
              if (link.href && link.href.includes('login')) {
                link.classList.add('text-ktm-light-text/70');
              } else {
                link.classList.add('text-ktm-light-text');
              }
            });
            if (authLink) {
              authLink.classList.remove('text-white', 'text-black', 'font-bold');
              authLink.classList.add('text-ktm-light-text/70');
            }
            if (mobileMenuBtn) {
              mobileMenuBtn.classList.remove('text-white', 'text-black');
              mobileMenuBtn.classList.add('text-ktm-light-text');
            }
          }
        } catch (e) {
          console.error('Error en checkNavbarColor:', e);
        }
      }

      // Inicializar cuando el DOM est√© listo
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        // Si ya est√° cargado, ejecutar inmediatamente
        setTimeout(init, 0);
      }

      function init() {
        console.log('üöÄ Inicializando scripts...');
        console.log('üöÄ HTML element:', document.documentElement);
        console.log('üöÄ HTML classes al inicio:', document.documentElement.className);
        
        // Inicializar tema
        initTheme();
        
        // Verificar despu√©s de un momento
        setTimeout(() => {
          console.log('üîç Verificaci√≥n post-init:');
          console.log('  - HTML tiene dark?', document.documentElement.classList.contains('dark'));
          console.log('  - Body classes:', document.body.className);
          console.log('  - Body computed background:', window.getComputedStyle(document.body).backgroundColor);
        }, 500);
        
        // Configurar event listeners
        const themeToggle = document.getElementById('theme-toggle');
        const themeToggleMobile = document.getElementById('theme-toggle-mobile');
        
        console.log('üîç Toggle buttons encontrados:', {
          desktop: !!themeToggle,
          mobile: !!themeToggleMobile
        });
        
        if (themeToggle) {
          themeToggle.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            console.log('üñ±Ô∏è Click en toggle desktop');
            toggleTheme();
            return false;
          };
        }
        
        if (themeToggleMobile) {
          themeToggleMobile.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            console.log('üñ±Ô∏è Click en toggle mobile');
            toggleTheme();
            return false;
          };
        }
        
        document.getElementById('mobile-menu-btn')?.addEventListener('click', () => {
          const menu = document.getElementById('mobile-menu');
          menu?.classList.toggle('hidden');
        });

        // Verificar color del navbar
        setTimeout(() => {
          checkNavbarColor();
        }, 200);
        
        // Escuchar scroll con throttling
        let scrollTimeout;
        let lastScrollY = window.scrollY;
        let ticking = false;
        
        function onScroll() {
          if (!ticking) {
            window.requestAnimationFrame(() => {
              const currentScrollY = window.scrollY;
              
              if (Math.abs(currentScrollY - lastScrollY) > 5) {
                checkNavbarColor();
                lastScrollY = currentScrollY;
              }
              
              ticking = false;
            });
            ticking = true;
          }
        }
        
        window.addEventListener('scroll', onScroll, { passive: true });
        
        window.addEventListener('resize', () => {
          clearTimeout(scrollTimeout);
          scrollTimeout = setTimeout(checkNavbarColor, 100);
        });
        
        // Escuchar cambios de tema desde otros scripts
        window.addEventListener('themechange', () => {
          console.log('üì¢ Evento themechange recibido');
          setTimeout(checkNavbarColor, 50);
        });
      }
    </script>

    <!-- Script ligero para manejar el carrito -->
    <script type="module">
      const STORAGE_KEY = 'mimoto_cart_v1';

      function loadCart() {
        try {
          const raw = JSON.parse(localStorage.getItem(STORAGE_KEY));
          if (Array.isArray(raw)) return raw;
          if (raw && Array.isArray(raw.items)) return raw.items;
        } catch {
          // ignore
        }
        return [];
      }

      function saveCart(cart) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(cart));
      }

      function renderCart(cart) {
        const itemsEl = document.getElementById('cart-items');
        const totalEl = document.getElementById('cart-total');
        if (!itemsEl || !totalEl) return;

        if (cart.length === 0) {
          itemsEl.innerHTML = '<p class="text-ktm-light-textMuted dark:text-ktm-textMuted text-center py-8">Tu carrito est√° vac√≠o.</p>';
          totalEl.textContent = '$0';
          return;
        }

        let total = 0;
        itemsEl.innerHTML = cart
          .map((item) => {
            const lineTotal = item.price * item.quantity;
            total += lineTotal;
            return `<div class="flex justify-between items-center gap-3 p-3 bg-ktm-light-surfaceAlt dark:bg-ktm-surfaceAlt border border-ktm-light-border dark:border-ktm-border rounded-lg">
                <div class="flex-1">
                  <span class="font-semibold text-ktm-light-text dark:text-ktm-text block">${item.name}</span>
                  <span class="text-xs text-ktm-light-textMuted dark:text-ktm-textMuted">
                    $${item.price.toLocaleString('es-CL')} c/u
                  </span>
                </div>
                <div class="flex items-center gap-2">
                  <button
                    type="button"
                    data-cart-dec
                    data-id="${item.id}"
                    class="w-7 h-7 rounded border border-ktm-accent/50 text-ktm-accent hover:bg-ktm-accent hover:text-black transition-colors font-bold"
                  >-</button>
                  <span class="min-w-[2rem] text-center font-semibold text-ktm-light-text dark:text-ktm-text">${item.quantity}</span>
                  <button
                    type="button"
                    data-cart-inc
                    data-id="${item.id}"
                    class="w-7 h-7 rounded border border-ktm-accent/50 text-ktm-accent hover:bg-ktm-accent hover:text-black transition-colors font-bold"
                  >+</button>
                  <button
                    type="button"
                    data-cart-remove
                    data-id="${item.id}"
                    class="ml-2 text-ktm-accent hover:text-ktm-accentSoft text-lg"
                    title="Eliminar"
                  >üóë</button>
                </div>
              </div>`;
          })
          .join('');
        totalEl.textContent = `$${total.toLocaleString('es-CL')}`;
      }

      function openCart() {
        document.getElementById('cart-sidebar')?.classList.remove('translate-x-full');
        const backdrop = document.getElementById('cart-backdrop');
        if (backdrop) {
          backdrop.classList.remove('pointer-events-none');
          backdrop.classList.add('opacity-100');
        }
      }

      function closeCart() {
        document.getElementById('cart-sidebar')?.classList.add('translate-x-full');
        const backdrop = document.getElementById('cart-backdrop');
        if (backdrop) {
          backdrop.classList.add('pointer-events-none');
          backdrop.classList.remove('opacity-100');
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        renderCart(loadCart());

        document.querySelectorAll('[data-cart-open]').forEach((btn) => {
          btn.addEventListener('click', () => {
            renderCart(loadCart());
            openCart();
          });
        });

        document.querySelectorAll('[data-cart-close]').forEach((btn) => {
          btn.addEventListener('click', closeCart);
        });

        document
          .getElementById('cart-backdrop')
          ?.addEventListener('click', () => closeCart());

        document.getElementById('cart-items')?.addEventListener('click', (event) => {
          const target = event.target;
          if (!(target instanceof HTMLElement)) return;

          const incBtn = target.closest('[data-cart-inc]');
          const decBtn = target.closest('[data-cart-dec]');
          const removeBtn = target.closest('[data-cart-remove]');

          const btn = incBtn || decBtn || removeBtn;
          if (!btn) return;

          const id = btn.getAttribute('data-id');
          if (!id) return;

          let cart = loadCart();
          const index = cart.findIndex((item) => item.id === id);
          if (index === -1) return;

          if (incBtn) {
            cart[index].quantity += 1;
          } else if (decBtn) {
            cart[index].quantity = Math.max(1, cart[index].quantity - 1);
          } else if (removeBtn) {
            cart.splice(index, 1);
          }

          saveCart(cart);
          renderCart(cart);
        });

        document.body.addEventListener('click', (event) => {
          const target = event.target;
          if (!(target instanceof HTMLElement)) return;

          const btn = target.closest('[data-add-to-cart]');
          if (!btn) return;

          const id = btn.getAttribute('data-id');
          const name = btn.getAttribute('data-name');
          const priceAttr = btn.getAttribute('data-price');
          const price = priceAttr ? Number(priceAttr) : 0;

          if (!id || !name || !price) {
            return;
          }

          let cart = loadCart();
          const existing = cart.find((item) => item.id === id);
          if (existing) {
            existing.quantity += 1;
          } else {
            cart.push({ id, name, price, quantity: 1 });
          }
          saveCart(cart);
          renderCart(cart);
          openCart();
        });
      });
    </script>

    <!-- Script para manejar autenticaci√≥n en navbar -->
    <script type="module">
      import { supabaseClient } from '../../lib/supabase/client';

      async function updateAuthStatus() {
        const authStatusEl = document.getElementById('auth-status');
        const authStatusMobileEl = document.getElementById('auth-status-mobile');
        
        const { data: { session } } = await supabaseClient.auth.getSession();

        if (session?.user) {
          const { data: profile } = await supabaseClient
            .from('users')
            .select('full_name, role')
            .eq('id', session.user.id)
            .single();

          const userName = profile?.full_name || session.user.email?.split('@')[0] || 'Usuario';
          const isAdmin = profile?.role === 'admin';

          const authHTML = `
            <div class="flex items-center gap-2">
              <span class="text-ktm-light-textSecondary dark:text-ktm-textSecondary">${userName}</span>
              ${isAdmin ? '<a href="/admin" class="text-ktm-accent hover:text-ktm-accentSoft font-bold">Admin</a>' : ''}
              <button id="logout-btn" class="text-ktm-light-textMuted dark:text-ktm-textMuted hover:text-ktm-accent transition-colors">Salir</button>
            </div>
          `;
          
          if (authStatusEl) authStatusEl.innerHTML = authHTML;
          if (authStatusMobileEl) authStatusMobileEl.innerHTML = authHTML;

          document.getElementById('logout-btn')?.addEventListener('click', async () => {
            await supabaseClient.auth.signOut();
            window.location.href = '/';
          });
        } else {
          const guestHTML = `<a href="/login" id="auth-link" class="nav-link text-ktm-light-text/70 dark:text-white/80 hover:text-ktm-accent transition-colors">Iniciar sesi√≥n</a>`;
          if (authStatusEl) authStatusEl.innerHTML = guestHTML;
          if (authStatusMobileEl) authStatusMobileEl.innerHTML = guestHTML;
          
          // Re-evaluar el color del navbar despu√©s de actualizar auth
          setTimeout(() => {
            if (typeof checkNavbarColor === 'function') {
              checkNavbarColor();
            }
          }, 100);
        }
      }

      updateAuthStatus();
      supabaseClient.auth.onAuthStateChange(() => {
        updateAuthStatus();
      });
    </script>
  </body>
</html>
