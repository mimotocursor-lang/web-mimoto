---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { supabaseClient } from '../../lib/supabase/client';

// Esta p√°gina se renderiza est√°ticamente y usa JavaScript del lado del cliente
// para manejar la confirmaci√≥n del pago
// Puede recibir token_ws (pago normal) o TBK_TOKEN (pago cancelado)
const { orderId, token_ws, TBK_TOKEN, TBK_ID_SESION, TBK_ORDEN_COMPRA } = Astro.url.searchParams;
---

<BaseLayout title="Confirmaci√≥n de Pago - Mimoto">
  <section class="max-w-2xl mx-auto px-4 py-12 md:py-16 space-y-8">
    <div class="text-center mb-8">
      <h1 class="text-4xl md:text-5xl font-bold text-white mb-2">Confirmando tu pago</h1>
      <p class="text-white/80">Por favor espera mientras procesamos tu transacci√≥n...</p>
    </div>

    <div id="payment-status" class="bg-gray-900/50 border-2 border-primary rounded-xl p-8 shadow-lg space-y-6 backdrop-blur-sm">
      <div class="text-center">
        <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-primary/10 mb-4">
          <svg class="w-10 h-10 text-primary animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
        </div>
        <p class="text-white/90 text-lg">Procesando tu pago...</p>
      </div>
    </div>
  </section>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const statusEl = document.getElementById('payment-status');
      const urlParams = new URLSearchParams(window.location.search);
      const orderId = urlParams.get('orderId');
      
      // Detectar si viene TBK_TOKEN (cancelaci√≥n) o token_ws (pago normal)
      const tbkToken = urlParams.get('TBK_TOKEN');
      const tokenWs = urlParams.get('token_ws');
      
      // CASO 1: Pago cancelado por el usuario (TBK_TOKEN presente)
      if (tbkToken) {
        const tbkIdSesion = urlParams.get('TBK_ID_SESION');
        const tbkOrdenCompra = urlParams.get('TBK_ORDEN_COMPRA');
        
        console.log('üö´ Pago cancelado por el usuario');
        console.log('üìã Par√°metros de cancelaci√≥n:', {
          TBK_TOKEN: tbkToken,
          TBK_ID_SESION: tbkIdSesion,
          TBK_ORDEN_COMPRA: tbkOrdenCompra
        });
        
        statusEl.innerHTML = `
          <div class="text-center">
            <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-yellow-500/10 mb-4">
              <svg class="w-10 h-10 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
              </svg>
            </div>
            <h2 class="text-2xl font-bold text-white mb-2">Pago Cancelado</h2>
            <p class="text-white/90 mb-4">Has cancelado el proceso de pago en Webpay.</p>
            <p class="text-white/70 text-sm mb-4">No se ha realizado ning√∫n cargo a tu tarjeta.</p>
            <div class="flex gap-4 justify-center">
              <a href="/pago?orderId=${orderId}" class="inline-block px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary-600 transition-colors">
                Intentar nuevamente
              </a>
              <a href="/" class="inline-block px-6 py-3 border-2 border-primary text-primary rounded-lg hover:bg-primary/10 transition-colors">
                Volver al inicio
              </a>
            </div>
          </div>
        `;
        return;
      }

      // CASO 2: Pago normal (token_ws presente)
      if (!tokenWs) {
        statusEl.innerHTML = `
          <div class="text-center">
            <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-red-500/10 mb-4">
              <svg class="w-10 h-10 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </div>
            <h2 class="text-2xl font-bold text-white mb-2">Error</h2>
            <p class="text-white/90 mb-4">No se recibi√≥ el token de la transacci√≥n.</p>
            <a href="/pago?orderId=${orderId}" class="inline-block px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary-600 transition-colors">
              Volver al pago
            </a>
          </div>
        `;
        return;
      }

      try {
        console.log('üîÑ Iniciando confirmaci√≥n de pago...');
        console.log('üîë Token:', tokenWs);
        console.log('üìã OrderId:', orderId);
        
        // Confirmar la transacci√≥n con timeout m√°s largo (30 segundos)
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 segundos
        
        const response = await fetch('/api/webpay/confirm', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ token_ws: tokenWs }),
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);

        console.log('üì• Respuesta HTTP:', response.status, response.statusText);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('‚ùå Error HTTP:', errorText);
          throw new Error(`Error ${response.status}: ${errorText}`);
        }

        const result = await response.json();
        console.log('üìã Resultado de confirmaci√≥n completo:', JSON.stringify(result, null, 2));
        console.log('üìã responseCode:', result.responseCode, 'Tipo:', typeof result.responseCode);
        console.log('üìã success:', result.success, 'Tipo:', typeof result.success);
        console.log('üìã responseMessage:', result.responseMessage);

        // Verificar si el pago fue aprobado
        // El pago es exitoso si:
        // 1. responseCode === 0 (est√°ndar de Transbank)
        // 2. O si existe authorizationCode (indica que fue autorizado) - ESTO ES LO M√ÅS IMPORTANTE
        // 3. O si success === true
        // 4. O si hay transactionDate y amount (indica que la transacci√≥n se proces√≥)
        const responseCodeIsZero = result.responseCode === 0 || result.responseCode === '0';
        const successIsTrue = result.success === true || result.success === 'true';
        const hasAuthorizationCode = !!result.authorizationCode;
        const hasTransactionData = !!(result.transactionDate && result.amount);
        const hasExplicitError = result.responseMessage && 
                                 (result.responseMessage.toLowerCase().includes('error') ||
                                  result.responseMessage.toLowerCase().includes('rechazado') ||
                                  result.responseMessage.toLowerCase().includes('rejected'));
        
        // Si hay authorizationCode, significa que Transbank autoriz√≥ el pago - esto es definitivo
        // Si hay transactionDate y amount sin errores expl√≠citos, el pago fue exitoso
        // Si el responseCode es -1 pero hay authorizationCode, el pago fue exitoso
        const isPaymentApproved = responseCodeIsZero || successIsTrue || hasAuthorizationCode || (hasTransactionData && !hasExplicitError);
        
        console.log('üîç An√°lisis de aprobaci√≥n:', {
          responseCodeIsZero,
          successIsTrue,
          hasAuthorizationCode,
          hasTransactionData,
          hasExplicitError,
          isPaymentApproved,
          responseCode: result.responseCode,
          success: result.success,
          authorizationCode: result.authorizationCode,
          transactionDate: result.transactionDate,
          amount: result.amount,
          responseMessage: result.responseMessage,
          debug: result._debug,
          fullResult: JSON.stringify(result, null, 2)
        });
        
        // Si hay authorizationCode pero isPaymentApproved es false, forzar a true
        // porque authorizationCode significa que Transbank autoriz√≥ el pago
        if (hasAuthorizationCode && !isPaymentApproved) {
          console.log('‚ö†Ô∏è Hay authorizationCode pero isPaymentApproved es false. Forzando a true porque authorizationCode indica pago autorizado.');
          isPaymentApproved = true;
        }

        if (isPaymentApproved) {
          // Verificar si ya fue confirmado anteriormente
          if (result.alreadyConfirmed) {
            statusEl.innerHTML = `
            <div class="text-center">
              <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-blue-500/10 mb-4">
                <svg class="w-10 h-10 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
              <h2 class="text-2xl font-bold text-white mb-2">Pago Ya Confirmado</h2>
              <p class="text-white/90 mb-4">Esta transacci√≥n ya fue procesada y confirmada anteriormente.</p>
              <div class="flex gap-4 justify-center">
                <a href="/pedido/${result.orderId || orderId}" class="inline-block px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary-600 transition-colors">
                  Ver mi pedido
                </a>
                <a href="/" class="inline-block px-6 py-3 border-2 border-primary text-primary rounded-lg hover:bg-primary/10 transition-colors">
                  Volver al inicio
                </a>
              </div>
            </div>
          `;
          } else {
          // Pago exitoso - Mostrar informaci√≥n completa seg√∫n requerimientos de Transbank
          const formatAmount = (amount) => {
            if (!amount) return 'N/A';
            if (typeof amount === 'number') {
              return `$${amount.toLocaleString('es-CL')} CLP`;
            }
            return amount;
          };
          
          const formatDate = (dateString) => {
            if (!dateString) return 'N/A';
            try {
              const date = new Date(dateString);
              return date.toLocaleString('es-CL', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
              });
            } catch (e) {
              return dateString;
            }
          };
          
          const getPaymentType = (paymentTypeCode) => {
            const types = {
              'VD': 'D√©bito',
              'VN': 'Cr√©dito',
              'VC': 'Cr√©dito en Cuotas',
              'SI': 'Sin inter√©s',
              'S2': 'Sin inter√©s (2 cuotas)',
              'NC': 'Sin cuotas'
            };
            return types[paymentTypeCode] || 'N/A';
          };
          
          const getCardLastDigits = (cardDetail) => {
            if (!cardDetail) return 'N/A';
            if (typeof cardDetail === 'object' && cardDetail.cardNumber) {
              return cardDetail.cardNumber.slice(-4);
            }
            if (typeof cardDetail === 'string') {
              return cardDetail.slice(-4);
            }
            return 'N/A';
          };
          
          const installmentsText = result.installmentsNumber > 0 
            ? `${result.installmentsNumber} cuota${result.installmentsNumber > 1 ? 's' : ''}`
            : 'Sin cuotas';
          
          statusEl.innerHTML = `
            <div class="text-center">
              <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-green-500/10 mb-4">
                <svg class="w-10 h-10 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
              </div>
              <h2 class="text-2xl font-bold text-white mb-2">¬°Pago Exitoso!</h2>
              <p class="text-white/90 mb-4">Tu pago ha sido procesado correctamente.</p>
              
              <!-- Comprobante completo seg√∫n requerimientos de Transbank -->
              <div class="bg-gray-800/50 border-2 border-primary/30 rounded-lg p-6 space-y-3 mb-4 text-left">
                <h3 class="text-lg font-bold text-primary mb-4 text-center">Comprobante de Pago</h3>
                
                <!-- Nombre del comercio -->
                <div class="flex justify-between items-center pb-2 border-b border-gray-700">
                  <span class="text-white/90 font-semibold">Comercio:</span>
                  <span class="font-bold text-primary">MIMOTO</span>
                </div>
                
                <!-- N√∫mero de orden de pedido -->
                <div class="flex justify-between">
                  <span class="text-white/90">N√∫mero de orden:</span>
                  <span class="font-bold text-primary">${result.buyOrder || result.orderId || 'N/A'}</span>
                </div>
                
                <!-- Monto y moneda -->
                <div class="flex justify-between">
                  <span class="text-white/90">Monto pagado:</span>
                  <span class="font-bold text-primary">${formatAmount(result.amount)}</span>
                </div>
                
                <!-- C√≥digo de autorizaci√≥n -->
                <div class="flex justify-between">
                  <span class="text-white/90">C√≥digo de autorizaci√≥n:</span>
                  <span class="font-bold text-primary">${result.authorizationCode || 'N/A'}</span>
                </div>
                
                <!-- Fecha de la transacci√≥n -->
                <div class="flex justify-between">
                  <span class="text-white/90">Fecha de transacci√≥n:</span>
                  <span class="font-bold text-primary">${formatDate(result.transactionDate)}</span>
                </div>
                
                <!-- Tipo de pago -->
                <div class="flex justify-between">
                  <span class="text-white/90">Tipo de pago:</span>
                  <span class="font-bold text-primary">${getPaymentType(result.paymentTypeCode)}</span>
                </div>
                
                <!-- Cantidad de cuotas -->
                ${result.installmentsNumber > 0 ? `
                <div class="flex justify-between">
                  <span class="text-white/90">Cuotas:</span>
                  <span class="font-bold text-primary">${installmentsText}</span>
                </div>
                ` : ''}
                
                <!-- √öltimos 4 d√≠gitos de la tarjeta -->
                <div class="flex justify-between">
                  <span class="text-white/90">Tarjeta terminada en:</span>
                  <span class="font-bold text-primary">****${getCardLastDigits(result.cardDetail)}</span>
                </div>
                
                <!-- Descripci√≥n de bienes/servicios -->
                ${result.orderItems && result.orderItems.length > 0 ? `
                <div class="pt-2 border-t border-gray-700">
                  <span class="text-white/90 font-semibold block mb-2">Productos:</span>
                  <ul class="space-y-1">
                    ${result.orderItems.map(item => `
                      <li class="text-white/80 text-sm">‚Ä¢ ${item.name || item.product_name || 'Producto'} - ${item.quantity || 1} unidad(es) - $${Number(item.price || 0).toLocaleString('es-CL')}</li>
                    `).join('')}
                  </ul>
                </div>
                ` : ''}
              </div>
              
              <div class="flex gap-4 justify-center">
                <a href="/pedido/${result.orderId || orderId}" class="inline-block px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary-600 transition-colors">
                  Ver mi pedido
                </a>
                <a href="/" class="inline-block px-6 py-3 border-2 border-primary text-primary rounded-lg hover:bg-primary/10 transition-colors">
                  Volver al inicio
                </a>
              </div>
            </div>
          `;
          }
        } else {
          // Pago rechazado - Mostrar informaci√≥n del pedido sin token
          console.log('‚ùå Pago rechazado, detalles:', {
            responseCode: result.responseCode,
            responseMessage: result.responseMessage,
            orderId: result.orderId,
            amount: result.amount
          });
          
          // Obtener informaci√≥n del pedido para mostrar
          let orderInfo = null;
          try {
            if (typeof supabase !== 'undefined' && result.orderId) {
              const supabaseUrl = window.PUBLIC_SUPABASE_URL || 'https://prizpqahcluomioxnmex.supabase.co';
              const supabaseAnonKey = window.PUBLIC_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InByaXpwcWFoY2x1b21pb3hubWV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3OTIxNjIsImV4cCI6MjA3MzM2ODE2Mn0.7qJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJq';
              const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);
              
              const { data: order, error: orderError } = await supabaseClient
                .from('orders')
                .select('id, total_amount, status, created_at')
                .eq('id', result.orderId)
                .single();
              
              if (!orderError && order) {
                orderInfo = order;
              }
            }
          } catch (e) {
            console.log('‚ö†Ô∏è No se pudo obtener informaci√≥n del pedido:', e);
          }
          
          statusEl.innerHTML = `
            <div class="text-center">
              <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-red-500/10 mb-4">
                <svg class="w-10 h-10 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </div>
              <h2 class="text-2xl font-bold text-white mb-2">Pago Rechazado</h2>
              <p class="text-white/90 mb-2">${result.responseMessage || 'Tu pago no pudo ser procesado.'}</p>
              <p class="text-white/70 text-sm mb-4">C√≥digo de respuesta: ${result.responseCode || 'N/A'}</p>
              
              ${orderInfo ? `
              <!-- Informaci√≥n del pedido -->
              <div class="bg-gray-800/50 border-2 border-primary/30 rounded-lg p-6 space-y-3 mb-4 text-left">
                <h3 class="text-lg font-bold text-primary mb-4 text-center">Informaci√≥n del Pedido</h3>
                
                <div class="flex justify-between">
                  <span class="text-white/90">N√∫mero de pedido:</span>
                  <span class="font-bold text-primary">#${orderInfo.id}</span>
                </div>
                
                <div class="flex justify-between">
                  <span class="text-white/90">Monto:</span>
                  <span class="font-bold text-primary">$${Number(orderInfo.total_amount).toLocaleString('es-CL')} CLP</span>
                </div>
                
                <div class="flex justify-between">
                  <span class="text-white/90">Estado:</span>
                  <span class="font-bold text-primary">${orderInfo.status || 'Pendiente'}</span>
                </div>
              </div>
              ` : result.orderId ? `
              <div class="bg-gray-800/50 border-2 border-primary/30 rounded-lg p-4 mb-4">
                <p class="text-white/90">ID del pedido: <span class="font-bold text-primary">#${result.orderId}</span></p>
                ${result.amount ? `<p class="text-white/90 mt-2">Monto: <span class="font-bold text-primary">$${Number(result.amount).toLocaleString('es-CL')} CLP</span></p>` : ''}
              </div>
              ` : ''}
              
              <div class="flex gap-4 justify-center">
                <a href="/pago?orderId=${orderId || result.orderId}" class="inline-block px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary-600 transition-colors">
                  Intentar nuevamente
                </a>
                <a href="/" class="inline-block px-6 py-3 border-2 border-primary text-primary rounded-lg hover:bg-primary/10 transition-colors">
                  Volver al inicio
                </a>
              </div>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error confirmando pago:', error);
        statusEl.innerHTML = `
          <div class="text-center">
            <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-yellow-500/10 mb-4">
              <svg class="w-10 h-10 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
              </svg>
            </div>
            <h2 class="text-2xl font-bold text-white mb-2">Error al procesar</h2>
            <p class="text-white/90 mb-4">Ocurri√≥ un error al confirmar tu pago. Por favor, contacta con soporte.</p>
            <div class="flex gap-4 justify-center">
              <a href="/pago?orderId=${orderId}" class="inline-block px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary-600 transition-colors">
                Volver al pago
              </a>
              <a href="/" class="inline-block px-6 py-3 border-2 border-primary text-primary rounded-lg hover:bg-primary/10 transition-colors">
                Volver al inicio
              </a>
            </div>
          </div>
        `;
      }
    });
  </script>
</BaseLayout>

