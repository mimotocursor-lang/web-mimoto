---
import BaseLayout from '../../layouts/BaseLayout.astro';
---

<BaseLayout title="Dashboard Admin - Mimoto">
  <section class="max-w-6xl mx-auto px-4 py-16">
    <div class="flex items-center justify-between mb-8">
      <h1 class="text-3xl font-bold text-ktm-light-text dark:text-ktm-text">Dashboard Admin</h1>
      <nav class="flex gap-4 text-sm">
        <a href="/admin" class="text-ktm-accent dark:text-ktm-accent font-bold">Dashboard</a>
        <a href="/admin/productos" class="text-ktm-light-text/80 dark:text-ktm-text/80 hover:text-ktm-accent font-semibold">Productos</a>
        <a href="/admin/motos-usadas" class="text-ktm-light-text/80 dark:text-ktm-text/80 hover:text-ktm-accent font-semibold">Motos Usadas</a>
        <a href="/admin/banners" class="text-ktm-light-text/80 dark:text-ktm-text/80 hover:text-ktm-accent font-semibold">Banners</a>
      </nav>
    </div>

    <div id="admin-content" class="space-y-6">
      <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="border-2 border-ktm-accent dark:border-primary rounded-xl p-6 bg-white dark:bg-ktm-surface/50 shadow-lg">
          <p class="text-xs text-gray-600 dark:text-ktm-text/70 mb-1 font-semibold uppercase">Total Ventas</p>
          <p id="kpi-sales" class="text-3xl font-bold text-ktm-accent">$0</p>
        </div>
        <div class="border-2 border-gray-200 dark:border-primary/30 rounded-xl p-6 bg-white dark:bg-ktm-surface/50 shadow-lg">
          <p class="text-xs text-gray-600 dark:text-ktm-text/70 mb-1 font-semibold uppercase">Productos Activos</p>
          <p id="kpi-products-active" class="text-3xl font-bold text-gray-900 dark:text-ktm-text">0</p>
        </div>
        <div class="border-2 border-gray-200 dark:border-primary/30 rounded-xl p-6 bg-white dark:bg-ktm-surface/50 shadow-lg">
          <p class="text-xs text-gray-600 dark:text-ktm-text/70 mb-1 font-semibold uppercase">Motos Activas</p>
          <p id="kpi-motos-active" class="text-3xl font-bold text-gray-900 dark:text-ktm-text">0</p>
        </div>
        <div class="border-2 border-gray-200 dark:border-primary/30 rounded-xl p-6 bg-white dark:bg-ktm-surface/50 shadow-lg">
          <p class="text-xs text-gray-600 dark:text-ktm-text/70 mb-1 font-semibold uppercase">Órdenes Totales</p>
          <p id="kpi-orders" class="text-3xl font-bold text-gray-900 dark:text-ktm-text">0</p>
        </div>
      </div>

      <div class="border-2 border-gray-200 dark:border-primary/30 rounded-xl p-6 bg-white dark:bg-ktm-surface/50 shadow-lg">
        <h2 class="font-bold text-xl mb-4 text-gray-900 dark:text-ktm-text">Productos con stock bajo</h2>
        <div id="low-stock-products" class="text-sm text-gray-700 dark:text-ktm-text/80">
          <p class="text-gray-600 dark:text-ktm-text/70">Cargando...</p>
        </div>
      </div>
    </div>
  </section>

  <script>
    import { supabaseClient } from '../../lib/supabase/client';

    async function checkAdminAccess() {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) {
        window.location.href = '/login?return=/admin';
        return false;
      }

      const { data: profile } = await supabaseClient
        .from('users')
        .select('role')
        .eq('id', session.user.id)
        .single();

      if (profile?.role !== 'admin') {
        alert('No tienes permisos para acceder a esta página');
        window.location.href = '/';
        return false;
      }

      return true;
    }

    async function loadDashboardData() {
      const hasAccess = await checkAdminAccess();
      if (!hasAccess) return;

      try {
        // Cargar KPIs desde Supabase
        const [ordersRes, productsRes, motosRes] = await Promise.all([
          supabaseClient.from('orders').select('total_amount, status'),
          supabaseClient.from('products').select('id, status, stock'),
          supabaseClient.from('used_motorcycles').select('id, status'),
        ]);

        // Calcular total de ventas (solo órdenes pagadas)
        const totalSales = ordersRes.data
          ?.filter((o) => o.status === 'paid')
          .reduce((sum, o) => sum + Number(o.total_amount || 0), 0) || 0;

        // Contar productos activos
        const productsActive = productsRes.data?.filter((p) => p.status === 'active').length || 0;

        // Contar motos activas
        const motosActive = motosRes.data?.filter((m) => m.status === 'active').length || 0;

        // Total de órdenes
        const totalOrders = ordersRes.data?.length || 0;

        // Productos con stock bajo
        const lowStock = productsRes.data?.filter((p) => p.stock <= 5 && p.status === 'active') || [];

        // Actualizar UI
        document.getElementById('kpi-sales')!.textContent = `$${totalSales.toLocaleString('es-CL')}`;
        document.getElementById('kpi-products-active')!.textContent = productsActive.toString();
        document.getElementById('kpi-motos-active')!.textContent = motosActive.toString();
        document.getElementById('kpi-orders')!.textContent = totalOrders.toString();

        const lowStockEl = document.getElementById('low-stock-products')!;
        if (lowStock.length === 0) {
          lowStockEl.innerHTML = '<p class="text-zinc-400">No hay productos con stock bajo</p>';
        } else {
          lowStockEl.innerHTML = lowStock
            .map((p) => `<div class="flex justify-between py-2 border-b border-zinc-800 last:border-0">
              <span>Producto ID: ${p.id}</span>
              <span class="text-red-400">Stock: ${p.stock}</span>
            </div>`)
            .join('');
        }
      } catch (err) {
        console.error('Error cargando dashboard:', err);
      }
    }

    document.addEventListener('DOMContentLoaded', loadDashboardData);
  </script>
</BaseLayout>

