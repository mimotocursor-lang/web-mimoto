---
import BaseLayout from '../layouts/BaseLayout.astro';
import { supabaseClient } from '../lib/supabase/client';

const { orderId } = Astro.url.searchParams;

// Logging inicial para debugging
console.log('üîç Pago.astro - Iniciando:', {
  orderId: orderId || 'NO HAY ORDERID',
  orderIdType: typeof orderId,
  url: Astro.url.href,
  searchParams: Object.fromEntries(Astro.url.searchParams.entries())
});

// Obtener el monto del pedido desde la base de datos
let orderTotal = null;
let orderStatus = null;
let userEmail = null;
let orderFound = false;

if (orderId) {
  try {
    console.log('üîç Intentando obtener pedido con orderId:', orderId);
    
    // Intentar obtener el pedido con el ID como n√∫mero (BIGSERIAL)
    const orderIdNum = Number(orderId);
    let order = null;
    let error = null;
    
    // Intentar primero con el ID como n√∫mero
    if (!isNaN(orderIdNum)) {
      console.log('üîç Buscando pedido como n√∫mero:', orderIdNum);
      const result = await supabaseClient
        .from('orders')
        .select('id, total_amount, status, user_id, created_at')
        .eq('id', orderIdNum)
        .single();
      order = result.data;
      error = result.error;
      
      console.log('üîç Resultado b√∫squeda como n√∫mero:', {
        found: !!order,
        error: error?.message || null,
        data: order ? { id: order.id, total: order.total_amount } : null
      });
    }
    
    // Si no se encuentra, intentar con el ID como string
    if (error || !order) {
      console.log('üîç Buscando pedido como string:', orderId);
      const result = await supabaseClient
      .from('orders')
        .select('id, total_amount, status, user_id, created_at')
      .eq('id', orderId)
      .single();
      order = result.data;
      error = result.error;
      
      console.log('üîç Resultado b√∫squeda como string:', {
        found: !!order,
        error: error?.message || null,
        data: order ? { id: order.id, total: order.total_amount } : null
      });
    }

    if (!error && order) {
      orderTotal = Number(order.total_amount);
      orderStatus = order.status;
      orderFound = true;
      
      console.log('‚úÖ Pedido encontrado:', {
        id: order.id,
        total: orderTotal,
        status: orderStatus,
        user_id: order.user_id || 'null'
      });
      
      // Obtener email del usuario si hay user_id (opcional, no cr√≠tico)
      if (order.user_id) {
        try {
      const { data: { user } } = await supabaseClient.auth.getUser();
      if (user) {
        userEmail = user.email;
      }
        } catch (userErr) {
          console.log('‚ÑπÔ∏è No se pudo obtener email del usuario (no cr√≠tico)');
        }
      }
    } else {
      console.error('‚ùå Error obteniendo pedido:', error);
      console.error('‚ùå OrderId usado:', orderId, 'Tipo:', typeof orderId);
      console.error('‚ùå Detalles del error:', {
        message: error?.message,
        code: error?.code,
        details: error?.details,
        hint: error?.hint
      });
    }
  } catch (err) {
    console.error('‚ùå Error inesperado obteniendo el pedido:', err);
    console.error('‚ùå Stack:', err instanceof Error ? err.stack : 'N/A');
  }
} else {
  console.warn('‚ö†Ô∏è No hay orderId en los par√°metros de la URL');
  console.warn('‚ö†Ô∏è URL completa:', Astro.url.href);
  console.warn('‚ö†Ô∏è Search params:', Object.fromEntries(Astro.url.searchParams.entries()));
}
---

<BaseLayout title="Pago - Mimoto">
  <section class="max-w-2xl mx-auto px-4 sm:px-6 py-8 sm:py-12 md:py-16 space-y-6 sm:space-y-8">
    <div class="text-center mb-6 sm:mb-8">
      <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-white mb-2">Pago de tu pedido</h1>
      <p class="text-sm sm:text-base text-white/80">Finaliza tu compra realizando el pago</p>
    </div>

    <div class="bg-gray-900/50 border-2 border-primary rounded-xl p-4 sm:p-6 md:p-8 shadow-lg space-y-4 sm:space-y-6 backdrop-blur-sm">
      <div class="text-center">
        <div class="inline-flex items-center justify-center w-16 h-16 sm:w-20 sm:h-20 rounded-full bg-primary/10 mb-3 sm:mb-4">
          <svg class="w-8 h-8 sm:w-10 sm:h-10 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
        <p class="text-white/90 text-base sm:text-lg">
          Para finalizar tu compra, realiza el pago en el siguiente enlace. Una vez que el
          pago se confirme, validaremos tu pedido manualmente.
        </p>
      </div>

      <div class="bg-gray-800/50 border-2 border-primary/30 rounded-lg p-4 sm:p-6 space-y-3 sm:space-y-4">
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2">
          <span class="text-white/90 font-semibold text-sm sm:text-base">Pedido asociado:</span>
          <span class="font-bold text-primary text-lg sm:text-xl" id="order-id-display">
            {orderId ? `#${orderId}` : '‚Äî'}
          </span>
        </div>
        
          <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center border-t border-primary/30 pt-3 sm:pt-4 gap-2">
            <span class="text-white/90 font-semibold text-sm sm:text-base">Monto a pagar:</span>
          <span class="font-bold text-primary text-lg sm:text-xl" data-order-total>
            {orderTotal ? `$${orderTotal.toLocaleString('es-CL')}` : orderId ? 'Cargando...' : '‚Äî'}
          </span>
        </div>
        
        {!orderFound && orderId && (
          <div class="bg-yellow-500/10 border-l-4 border-yellow-500 p-3 rounded mt-2">
            <p class="text-xs text-yellow-200">
              ‚ö†Ô∏è No se pudo cargar la informaci√≥n del pedido. El cliente intentar√° cargarla autom√°ticamente.
            </p>
          </div>
        )}
        
        <button
          id="pay-button"
          type="button"
          class="w-full inline-flex items-center justify-center px-4 sm:px-6 md:px-8 py-3 sm:py-4 rounded-lg bg-primary text-white font-bold hover:bg-primary-600 transition-colors shadow-md text-base sm:text-lg disabled:opacity-50 disabled:cursor-not-allowed"
          disabled={!orderId}
        >
          <svg class="w-4 h-4 sm:w-5 sm:h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <span id="pay-button-text">Pagar ahora</span>
        </button>
        {!orderTotal && orderId && (
          <p class="text-xs text-yellow-400 text-center mt-2">
            ‚ö†Ô∏è Cargando informaci√≥n del pedido...
          </p>
        )}
      </div>

      <div class="bg-primary/10 border-l-4 border-primary p-3 sm:p-4 rounded">
        <p class="text-xs sm:text-sm text-white/90">
          <strong>Importante:</strong> Despu√©s de realizar el pago, recibir√°s una confirmaci√≥n por WhatsApp o correo
          cuando tu pedido cambie a estado <strong>en revisi√≥n</strong>.
        </p>
      </div>

      {!orderTotal && orderId && (
        <div class="bg-yellow-500/10 border-l-4 border-yellow-500 p-4 rounded">
          <p class="text-sm text-yellow-200">
            <strong>Nota:</strong> No se pudo obtener el monto del pedido. Por favor, recarga la p√°gina o contacta con soporte.
          </p>
        </div>
      )}
    </div>
  </section>

  <script define:vars={{ orderTotal: orderTotal, orderId: orderId, orderFound: orderFound }}>
    document.addEventListener('DOMContentLoaded', async () => {
      const payButton = document.getElementById('pay-button');
      const payButtonText = document.getElementById('pay-button-text');
      const urlParams = new URLSearchParams(window.location.search);
      const orderIdFromUrl = urlParams.get('orderId') || orderId;

      console.log('üîç Estado inicial (cliente):', {
        payButton: !!payButton,
        orderIdFromUrl: orderIdFromUrl,
        orderIdFromServer: orderId,
        orderTotal: orderTotal,
        orderFound: orderFound,
        buttonDisabled: payButton?.disabled,
        urlParams: window.location.search
      });

      // Actualizar el display del orderId si est√° disponible
      const orderIdDisplay = document.getElementById('order-id-display');
      if (orderIdDisplay) {
        if (orderIdFromUrl) {
          orderIdDisplay.textContent = `#${orderIdFromUrl}`;
          console.log('‚úÖ OrderId actualizado en UI:', orderIdFromUrl);
        } else {
          console.warn('‚ö†Ô∏è No hay orderId para mostrar');
        }
      } else {
        console.error('‚ùå Elemento order-id-display no encontrado');
      }

      if (!payButton) {
        console.error('‚ùå Bot√≥n de pago no encontrado');
        return;
      }

      if (!orderIdFromUrl || orderIdFromUrl === 'null' || orderIdFromUrl === 'undefined') {
        console.error('‚ùå No hay orderId v√°lido en la URL:', orderIdFromUrl);
        payButton.disabled = true;
        payButtonText.textContent = 'Error: No hay pedido asociado';
        
        // Mostrar mensaje de error visible
        const errorMsg = document.createElement('div');
        errorMsg.className = 'bg-red-500/10 border-l-4 border-red-500 p-4 rounded mt-4';
        errorMsg.innerHTML = `
          <p class="text-sm text-red-200">
            <strong>Error:</strong> No se encontr√≥ un pedido v√°lido. Por favor, vuelve al checkout e intenta nuevamente.
          </p>
          <a href="/checkout" class="inline-block mt-2 px-4 py-2 bg-primary text-white rounded hover:bg-primary-600 transition-colors text-sm">
            Volver al Checkout
          </a>
        `;
        payButton.parentElement?.appendChild(errorMsg);
        return;
      }

      // Si no hay orderTotal o no se encontr√≥ el pedido, intentar obtenerlo del cliente
      let finalOrderTotal = orderTotal;
      if (!finalOrderTotal || !orderFound) {
        console.log('‚ö†Ô∏è No hay orderTotal o pedido no encontrado, intentando obtener del cliente...');
        console.log('‚ö†Ô∏è orderTotal:', finalOrderTotal, 'orderFound:', orderFound);
        try {
          // Usar Supabase desde el CDN (ya cargado en BaseLayout)
          if (typeof supabase === 'undefined') {
            console.error('‚ùå Supabase no est√° disponible. Aseg√∫rate de que el CDN se haya cargado.');
            payButton.disabled = true;
            payButtonText.textContent = 'Error: Supabase no disponible';
            return;
          }
          
          const supabaseUrl = window.PUBLIC_SUPABASE_URL || 'https://prizpqahcluomioxnmex.supabase.co';
          const supabaseAnonKey = window.PUBLIC_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InByaXpwcWFoY2x1b21pb3hubWV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3OTIxNjIsImV4cCI6MjA3MzM2ODE2Mn0.7qJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJq';
          const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);

          // Intentar buscar el pedido como n√∫mero primero
          const orderIdNum = Number(orderIdFromUrl);
          let order = null;
          let error = null;
          
          if (!isNaN(orderIdNum)) {
            const result = await supabaseClient
              .from('orders')
              .select('id, total_amount, status')
              .eq('id', orderIdNum)
              .single();
            order = result.data;
            error = result.error;
          }
          
          // Si no se encuentra, intentar como string
          if (error || !order) {
            const result = await supabaseClient
            .from('orders')
              .select('id, total_amount, status')
            .eq('id', orderIdFromUrl)
            .single();
            order = result.data;
            error = result.error;
          }

          if (error || !order) {
            console.error('‚ùå Error obteniendo pedido:', error);
            console.error('‚ùå OrderId usado:', orderIdFromUrl, 'Tipo:', typeof orderIdFromUrl);
            console.error('‚ùå OrderId como n√∫mero:', orderIdNum);
            
            // Mostrar mensaje de error m√°s detallado
            payButton.disabled = true;
            payButtonText.textContent = 'Error: Pedido no encontrado';
            
            const errorMsg = document.createElement('div');
            errorMsg.className = 'bg-red-500/10 border-l-4 border-red-500 p-4 rounded mt-4';
            errorMsg.innerHTML = `
              <p class="text-sm text-red-200 mb-2">
                <strong>Error:</strong> No se encontr√≥ el pedido #${orderIdFromUrl} en la base de datos.
              </p>
              <p class="text-xs text-red-300 mb-3">
                Esto puede ocurrir si el pedido fue eliminado o si hay un problema con la conexi√≥n a la base de datos.
              </p>
              <a href="/checkout" class="inline-block px-4 py-2 bg-primary text-white rounded hover:bg-primary-600 transition-colors text-sm">
                Volver al Checkout
              </a>
            `;
            payButton.parentElement?.appendChild(errorMsg);
            return;
          }

          if (order && order.total_amount) {
            console.log('‚úÖ Pedido obtenido, total:', order.total_amount);
            finalOrderTotal = Number(order.total_amount);
            // Habilitar el bot√≥n si encontramos el total
            payButton.disabled = false;
            
            // Actualizar el monto en la UI
            const amountEl = document.querySelector('[data-order-total]');
            if (amountEl) {
              amountEl.textContent = '$' + finalOrderTotal.toLocaleString('es-CL');
            }
            
            // Ocultar mensaje de carga
            const loadingMsg = document.querySelector('.text-yellow-400');
            if (loadingMsg) {
              loadingMsg.style.display = 'none';
            }
          } else {
            console.error('‚ùå Pedido sin total_amount');
            payButton.disabled = true;
            payButtonText.textContent = 'Error: No se pudo obtener el monto';
            return;
          }
        } catch (err) {
          console.error('‚ùå Error:', err);
          payButton.disabled = true;
          payButtonText.textContent = 'Error al cargar pedido';
          return;
        }
      } else {
        // Si hay orderTotal, habilitar el bot√≥n
        payButton.disabled = false;
        console.log('‚úÖ Bot√≥n habilitado, orderTotal:', finalOrderTotal);
        
        // Actualizar el monto en la UI si no se mostr√≥ antes
        const amountEl = document.querySelector('[data-order-total]');
        if (amountEl && finalOrderTotal) {
          amountEl.textContent = '$' + finalOrderTotal.toLocaleString('es-CL');
        }
      }

      // Asegurar que el bot√≥n est√© habilitado si tenemos orderTotal y orderId
      if (finalOrderTotal && orderIdFromUrl) {
        if (payButton.disabled) {
          console.log('üîß Habilitando bot√≥n manualmente...');
          payButton.disabled = false;
        }
        
        // Actualizar el monto en la UI
        const amountEl = document.querySelector('[data-order-total]');
        if (amountEl) {
          amountEl.textContent = '$' + finalOrderTotal.toLocaleString('es-CL');
        }
      }

      payButton.addEventListener('click', async () => {
        console.log('üñ±Ô∏è Click en bot√≥n de pago');
        payButton.disabled = true;
        payButtonText.textContent = 'Iniciando pago...';

        try {
          // Obtener URL de retorno
          const returnUrl = `${window.location.origin}/pago/confirmar?orderId=${orderIdFromUrl}`;
          console.log('üîÑ URL de retorno:', returnUrl);

          // Iniciar transacci√≥n de Webpay
          console.log('üì° Llamando a /api/webpay/init...');
          const response = await fetch('/api/webpay/init', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              orderId: orderIdFromUrl,
              returnUrl
            }),
          });

          console.log('üì• Respuesta recibida, status:', response.status);
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå Error HTTP:', response.status, errorText);
            
            let errorMessage = `Error ${response.status}`;
            let errorDetails = null;
            
            try {
              const errorJson = JSON.parse(errorText);
              errorMessage = errorJson.error || errorMessage;
              errorDetails = errorJson.details || null;
            } catch (e) {
              errorMessage = errorText || errorMessage;
            }

            // Mensaje m√°s espec√≠fico para error 401
            if (response.status === 401) {
              errorMessage = 'Error de autenticaci√≥n con Webpay. Las credenciales de producci√≥n pueden estar incorrectas. Por favor, contacta con soporte.';
            }

            const error = new Error(errorMessage);
            error.details = errorDetails;
            throw error;
          }
          
          const result = await response.json();
          console.log('üìã Resultado completo:', result);

          if (result.success && result.url && result.token) {
            console.log('‚úÖ Redirigiendo a Webpay');
            console.log('üîó URL:', result.url);
            console.log('üîë Token:', result.token);
            
            // Webpay requiere enviar el token por POST, no por GET
            // Crear un formulario oculto y enviarlo autom√°ticamente
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = result.url;
            form.style.display = 'none';
            
            // Agregar el token como campo oculto
            const tokenInput = document.createElement('input');
            tokenInput.type = 'hidden';
            tokenInput.name = 'token_ws';
            tokenInput.value = result.token;
            form.appendChild(tokenInput);
            
            // Agregar el formulario al body y enviarlo
            document.body.appendChild(form);
            console.log('üì§ Enviando formulario POST a Webpay...');
            form.submit();
          } else {
            console.error('‚ùå Error en respuesta:', result);
            console.error('‚ùå URL presente:', !!result.url);
            console.error('‚ùå Token presente:', !!result.token);
            throw new Error(result.error || 'Error al iniciar el pago: respuesta inv√°lida');
          }
        } catch (error) {
          console.error('‚ùå Error completo iniciando pago:', error);
          payButton.disabled = false;
          payButtonText.textContent = 'Pagar ahora';
          
          let errorMessage = (error && error.message) ? error.message : 'Error al iniciar el pago. Por favor, intenta nuevamente o contacta con soporte.';
          let errorDetails = error && error.details ? error.details : null;
          
          // Mostrar error en la UI en lugar de solo alert
          const errorContainer = document.createElement('div');
          errorContainer.className = 'bg-red-500/10 border-l-4 border-red-500 p-4 rounded mt-4';
          errorContainer.innerHTML = `
            <p class="text-sm text-red-200 mb-2">
              <strong>Error al iniciar el pago:</strong> ${errorMessage}
            </p>
            ${errorDetails ? `<p class="text-xs text-red-300 mb-2">${JSON.stringify(errorDetails)}</p>` : ''}
            <p class="text-xs text-red-300">
              Si el problema persiste, por favor contacta con soporte e incluye el n√∫mero de pedido: #${orderIdFromUrl}
            </p>
          `;
          
          // Insertar el error antes del bot√≥n
          const buttonContainer = payButton.parentElement;
          if (buttonContainer) {
            // Remover errores previos
            const prevError = buttonContainer.querySelector('.bg-red-500\\/10');
            if (prevError) prevError.remove();
            
            buttonContainer.insertBefore(errorContainer, payButton);
          } else {
            // Fallback a alert si no se puede insertar en la UI
          alert(errorMessage);
          }
        }
      });
    });
  </script>
</BaseLayout>
