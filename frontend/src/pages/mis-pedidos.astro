---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="Mis Pedidos - MIMOTO">
  <section class="max-w-6xl mx-auto px-4 py-12 md:py-16">
    <div class="text-center mb-8">
      <h1 class="text-4xl md:text-5xl font-bold text-white mb-2">Mis Pedidos</h1>
      <div class="w-24 h-1 bg-primary mx-auto"></div>
      <p class="text-white/80 mt-4">Consulta el estado y detalles de tus pedidos</p>
    </div>

    <div id="orders-container" class="space-y-6">
      <div class="text-center py-12">
        <p class="text-white/70">Cargando tus pedidos...</p>
      </div>
    </div>

    <div id="no-orders" class="hidden text-center py-12">
      <div class="bg-gray-900/50 border-2 border-primary/30 rounded-xl p-8 backdrop-blur-sm">
        <p class="text-white/80 text-lg mb-4">No tienes pedidos a√∫n</p>
        <a href="/tienda" class="inline-block px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary-600 transition-colors">
          Ir a la Tienda
        </a>
      </div>
    </div>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = 'https://prizpqahcluomioxnmex.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InByaXpwcWFoY2x1b21pb3hubWV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3OTIxNjIsImV4cCI6MjA3MzM2ODE2Mn0.7qJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJq';
    
    let supabaseClient = null;

    function initOrders() {
      if (typeof supabase === 'undefined') {
        setTimeout(initOrders, 100);
        return;
      }

      const supabaseUrl = (typeof window !== 'undefined' && window.PUBLIC_SUPABASE_URL) || SUPABASE_URL;
      const supabaseAnonKey = (typeof window !== 'undefined' && window.PUBLIC_SUPABASE_ANON_KEY) || SUPABASE_KEY;
      
      supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);
      
      checkAuthAndLoadOrders();
    }

    async function checkAuthAndLoadOrders() {
      try {
        const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
        
        if (sessionError || !session) {
          window.location.href = '/login?return=/mis-pedidos';
          return;
        }

        await loadOrders(session.user.id);
      } catch (error) {
        console.error('Error verificando autenticaci√≥n:', error);
        window.location.href = '/login?return=/mis-pedidos';
      }
    }

    async function loadOrders(userId) {
      const container = document.getElementById('orders-container');
      const noOrders = document.getElementById('no-orders');
      
      if (!container) return;

      try {
        const { data: orders, error } = await supabaseClient
          .from('orders')
          .select(`
            id,
            total_amount,
            status,
            payment_reference,
            payment_details,
            created_at,
            updated_at,
            order_items:order_items(
              id,
              quantity,
              unit_price,
              total_price,
              products:product_id(name, main_image_url)
            )
          `)
          .eq('user_id', userId)
          .order('created_at', { ascending: false });

        if (error) throw error;

        if (!orders || orders.length === 0) {
          container.classList.add('hidden');
          noOrders.classList.remove('hidden');
          return;
        }

        noOrders.classList.add('hidden');
        container.classList.remove('hidden');

        container.innerHTML = orders.map(order => {
          // Parsear payment_details si existe
          let paymentDetails = null;
          if (order.payment_details) {
            try {
              paymentDetails = typeof order.payment_details === 'string' 
                ? JSON.parse(order.payment_details) 
                : order.payment_details;
            } catch (e) {
              // Ignorar errores de parsing
            }
          }

          // Determinar el estado visual basado en payment_details si es necesario
          const displayStatus = (paymentDetails && 
            (paymentDetails.responseCode === 0 || paymentDetails.responseCode === '0' || paymentDetails.authorizationCode) && 
            order.status === 'pending_payment') ? 'paid' : order.status;

          const statusInfo = getStatusInfo(displayStatus);
          const statusColor = getStatusColor(displayStatus);

          return `
            <div class="bg-gray-900/50 border-2 border-primary/30 rounded-xl p-6 shadow-lg backdrop-blur-sm hover:border-primary/50 transition-colors">
              <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4">
                <div>
                  <h3 class="text-xl font-bold text-white mb-2">Pedido #${order.id}</h3>
                  <p class="text-white/70 text-sm">
                    Fecha: ${new Date(order.created_at).toLocaleDateString('es-CL', {
                      year: 'numeric',
                      month: 'long',
                      day: 'numeric',
                      hour: '2-digit',
                      minute: '2-digit'
                    })}
                  </p>
                </div>
                <div class="mt-4 md:mt-0 text-right">
                  <div class="inline-block px-4 py-2 rounded-full text-sm font-semibold ${statusColor} mb-2">
                    ${statusInfo.label}
                  </div>
                  <p class="text-2xl font-bold text-primary">$${Number(order.total_amount).toLocaleString('es-CL')}</p>
                </div>
              </div>

              ${order.order_items && order.order_items.length > 0 ? `
                <div class="border-t border-primary/30 pt-4 mt-4">
                  <h4 class="text-white font-semibold mb-3">Productos:</h4>
                  <div class="space-y-2">
                    ${order.order_items.map(item => `
                      <div class="flex items-center justify-between bg-gray-800/50 rounded-lg p-3">
                        <div class="flex items-center gap-3">
                          ${item.products?.main_image_url ? `
                            <img src="${item.products.main_image_url}" alt="${item.products.name}" class="w-12 h-12 object-cover rounded">
                          ` : ''}
                          <div>
                            <p class="text-white font-semibold">${item.products?.name || 'Producto'}</p>
                            <p class="text-white/70 text-sm">Cantidad: ${item.quantity}</p>
                          </div>
                        </div>
                        <p class="text-white font-bold">$${Number(item.total_price).toLocaleString('es-CL')}</p>
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}

              ${paymentDetails ? `
                <div class="border-t border-primary/30 pt-4 mt-4">
                  <h4 class="text-white font-semibold mb-2">Detalles del Pago:</h4>
                  <div class="bg-green-900/20 border border-green-500/30 rounded-lg p-3 space-y-1 text-sm">
                    ${paymentDetails.authorizationCode ? `
                      <p class="text-white/90">
                        <span class="text-white/70">C√≥digo de autorizaci√≥n:</span>
                        <span class="font-mono font-bold text-green-400">${paymentDetails.authorizationCode}</span>
                      </p>
                    ` : ''}
                    ${paymentDetails.transactionDate ? `
                      <p class="text-white/90">
                        <span class="text-white/70">Fecha de transacci√≥n:</span>
                        <span class="text-white">${new Date(paymentDetails.transactionDate).toLocaleString('es-CL')}</span>
                      </p>
                    ` : ''}
                    ${paymentDetails.paymentTypeCode ? `
                      <p class="text-white/90">
                        <span class="text-white/70">Tipo de pago:</span>
                        <span class="text-white">${getPaymentType(paymentDetails.paymentTypeCode)}</span>
                      </p>
                    ` : ''}
                  </div>
                </div>
              ` : ''}

              <div class="border-t border-primary/30 pt-4 mt-4 flex gap-3">
                <a href="/pedido/${order.id}" class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-600 transition-colors text-center font-semibold">
                  Ver Detalles Completos
                </a>
                ${order.status === 'pending_payment' ? `
                  <a href="/pago?orderId=${order.id}" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold">
                    Pagar Ahora
                  </a>
                ` : ''}
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error cargando pedidos:', error);
        container.innerHTML = `
          <div class="bg-red-900/20 border-2 border-red-500 rounded-xl p-6">
            <p class="text-red-400 text-center">Error al cargar tus pedidos. Por favor, intenta nuevamente.</p>
          </div>
        `;
      }
    }

    function getStatusInfo(status) {
      const statuses = {
        'pending_payment': { label: '‚è≥ Pendiente de Pago', icon: '‚è≥' },
        'waiting_confirmation': { label: '‚è≥ Esperando Confirmaci√≥n', icon: '‚è≥' },
        'paid': { label: '‚úÖ Pagado', icon: '‚úÖ' },
        'order_received': { label: 'üì¶ Pedido Recibido', icon: 'üì¶' },
        'order_confirmed': { label: '‚úÖ Pedido Confirmado', icon: '‚úÖ' },
        'order_delivered': { label: 'üöö Pedido Entregado', icon: 'üöö' },
        'cancelled': { label: '‚ùå Cancelado', icon: '‚ùå' }
      };
      return statuses[status] || { label: status, icon: 'üìã' };
    }

    function getStatusColor(status) {
      const colors = {
        'pending_payment': 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30',
        'waiting_confirmation': 'bg-blue-500/20 text-blue-400 border border-blue-500/30',
        'paid': 'bg-green-500/20 text-green-400 border border-green-500/30',
        'order_received': 'bg-purple-500/20 text-purple-400 border border-purple-500/30',
        'order_confirmed': 'bg-indigo-500/20 text-indigo-400 border border-indigo-500/30',
        'order_delivered': 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30',
        'cancelled': 'bg-red-500/20 text-red-400 border border-red-500/30'
      };
      return colors[status] || 'bg-gray-500/20 text-gray-400 border border-gray-500/30';
    }

    function getPaymentType(code) {
      const types = {
        'VD': 'D√©bito',
        'VN': 'Cr√©dito',
        'VC': 'Cr√©dito en Cuotas',
        'SI': '3 cuotas sin inter√©s',
        'S2': '2 cuotas sin inter√©s',
        'NC': 'N Cuotas sin inter√©s'
      };
      return types[code] || code || 'N/A';
    }

    // Inicializar cuando el DOM est√© listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initOrders);
    } else {
      initOrders();
    }
  </script>
</BaseLayout>

