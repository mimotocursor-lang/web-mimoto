---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { supabaseClient } from '../../lib/supabase/client';

// Esta ruta no se pre-renderiza porque los pedidos son dinámicos
export async function getStaticPaths() {
  return [];
}

const { id } = Astro.params;

// Obtener datos del pedido desde la base de datos
let order = null;
let orderItems = [];
let orderError = null;

if (id) {
  try {
    const { data, error } = await supabaseClient
      .from('orders')
      .select('id, total_amount, status, payment_reference, payment_details, created_at, updated_at')
      .eq('id', id)
      .single();

    if (!error && data) {
      order = data;
      
      // Obtener items del pedido
      const { data: items, error: itemsError } = await supabaseClient
        .from('order_items')
        .select('id, product_id, quantity, unit_price, total_price, products(name)')
        .eq('order_id', id);
      
      if (!itemsError && items) {
        orderItems = items;
      }
    } else {
      orderError = error;
    }
  } catch (err) {
    console.error('Error obteniendo el pedido:', err);
    orderError = err;
  }
}
---

<BaseLayout title={`Pedido #${id} - Mimoto`}>
  <section class="max-w-3xl mx-auto px-4 py-12 md:py-16 space-y-8">
    <div class="text-center mb-8">
      <h1 class="text-4xl md:text-5xl font-bold text-white mb-2">Estado del pedido #{id}</h1>
      <div class="w-24 h-1 bg-primary mx-auto"></div>
    </div>
    
    {order ? (
      <div class="bg-gray-900/50 border-2 border-primary rounded-xl p-8 shadow-lg space-y-6 backdrop-blur-sm">
        <div class="bg-gray-800/50 border-2 border-primary/30 rounded-lg p-6 space-y-4">
          <div class="flex justify-between items-center">
            <span class="text-white/90 font-semibold">Estado:</span>
            <span class={`font-bold text-xl ${
              order.status === 'paid' ? 'text-green-500' :
              order.status === 'pending_payment' || order.status === 'pending' ? 'text-yellow-500' :
              order.status === 'cancelled' ? 'text-red-500' :
              'text-primary'
            }`}>
              {order.status === 'paid' ? '✅ Pagado' :
               order.status === 'pending_payment' || order.status === 'pending' ? '⏳ Pendiente de pago' :
               order.status === 'cancelled' ? '❌ Cancelado' :
               order.status === 'waiting_confirmation' ? '⏳ Esperando confirmación' :
               order.status}
            </span>
          </div>
          
          <div class="flex justify-between items-center border-t border-primary/30 pt-4">
            <span class="text-white/90 font-semibold">Monto total:</span>
            <span class="font-bold text-primary text-xl">${Number(order.total_amount).toLocaleString('es-CL')}</span>
          </div>
          
          {order.payment_reference && (
            <div class="flex justify-between items-center border-t border-primary/30 pt-4">
              <span class="text-white/90 font-semibold">Referencia de pago:</span>
              <span class="font-mono text-xs text-primary break-all">{order.payment_reference}</span>
            </div>
          )}
          
          {order.payment_details && typeof order.payment_details === 'object' && (
            <div class="border-t border-primary/30 pt-4 space-y-2">
              <span class="text-white/90 font-semibold block mb-2">Detalles del pago:</span>
              {order.payment_details.authorizationCode && (
                <div class="flex justify-between">
                  <span class="text-white/70 text-sm">Código de autorización:</span>
                  <span class="text-primary font-mono text-sm">{order.payment_details.authorizationCode}</span>
                </div>
              )}
              {order.payment_details.responseCode !== undefined && (
                <div class="flex justify-between">
                  <span class="text-white/70 text-sm">Código de respuesta:</span>
                  <span class={`font-mono text-sm ${order.payment_details.responseCode === 0 ? 'text-green-500' : 'text-red-500'}`}>
                    {order.payment_details.responseCode}
                  </span>
                </div>
              )}
              {order.payment_details.transactionDate && (
                <div class="flex justify-between">
                  <span class="text-white/70 text-sm">Fecha de transacción:</span>
                  <span class="text-white/70 text-sm">{new Date(order.payment_details.transactionDate).toLocaleString('es-CL')}</span>
                </div>
              )}
            </div>
          )}
          
          <div class="flex justify-between items-center border-t border-primary/30 pt-4">
            <span class="text-white/90 font-semibold">Fecha de creación:</span>
            <span class="text-white/70 text-sm">{new Date(order.created_at).toLocaleString('es-CL')}</span>
          </div>
          
          {order.updated_at && order.updated_at !== order.created_at && (
            <div class="flex justify-between items-center border-t border-primary/30 pt-4">
              <span class="text-white/90 font-semibold">Última actualización:</span>
              <span class="text-white/70 text-sm">{new Date(order.updated_at).toLocaleString('es-CL')}</span>
            </div>
          )}
        </div>
        
        {orderItems.length > 0 && (
          <div class="bg-gray-800/50 border-2 border-primary/30 rounded-lg p-6 space-y-3">
            <h3 class="text-white font-bold text-lg mb-4">Items del pedido:</h3>
            {orderItems.map((item: any) => (
              <div class="flex justify-between items-center p-3 bg-gray-900/50 rounded-lg">
                <div>
                  <span class="text-white font-semibold">{item.products?.name || `Producto #${item.product_id}`}</span>
                  <span class="text-white/70 text-sm block">Cantidad: {item.quantity}</span>
                </div>
                <span class="font-bold text-primary">${Number(item.total_price).toLocaleString('es-CL')}</span>
              </div>
            ))}
          </div>
        )}
      </div>
    ) : (
      <div class="bg-gray-900/50 border-2 border-red-500 rounded-xl p-8 shadow-lg backdrop-blur-sm">
        <div class="text-center">
          <h2 class="text-2xl font-bold text-white mb-2">Pedido no encontrado</h2>
          <p class="text-white/90 mb-4">
            {orderError ? `Error: ${orderError.message}` : 'No se encontró un pedido con ese ID.'}
          </p>
          <a href="/" class="inline-block px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary-600 transition-colors">
            Volver al inicio
          </a>
        </div>
      </div>
    )}
  </section>
</BaseLayout>
