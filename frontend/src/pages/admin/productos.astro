---
import BaseLayout from '../../layouts/BaseLayout.astro';
---

<BaseLayout title="Gestión de Productos - Mimoto">
  <section class="max-w-7xl mx-auto px-4 md:px-8 py-12 md:py-20">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-8 gap-4">
      <h1 class="text-3xl md:text-4xl font-bold text-ktm-light-text dark:text-ktm-text">Gestión de Productos</h1>
      <nav class="flex gap-4 text-sm flex-wrap">
        <a href="/admin" class="text-ktm-light-text/80 dark:text-ktm-text/80 hover:text-ktm-accent font-semibold">Dashboard</a>
        <a href="/admin/productos" class="text-ktm-accent dark:text-ktm-accent font-bold">Productos</a>
        <a href="/admin/motos-usadas" class="text-ktm-light-text/80 dark:text-ktm-text/80 hover:text-ktm-accent font-semibold">Motos Usadas</a>
        <a href="/admin/banners" class="text-ktm-light-text/80 dark:text-ktm-text/80 hover:text-ktm-accent font-semibold">Banners</a>
      </nav>
    </div>

    <div class="mb-6 flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
      <button
        id="new-product-btn"
        class="px-6 py-3 rounded-lg bg-ktm-accent text-ktm-text font-bold hover:bg-ktm-accent-600 transition-colors shadow-lg"
      >
        + Nuevo Producto
      </button>
      <div class="text-sm text-ktm-light-text/70 dark:text-ktm-text/70">
        <span id="result-count">0</span> producto<span id="result-count-plural">s</span>
      </div>
    </div>

    <!-- Barra de búsqueda y filtros -->
    <div class="mb-8 space-y-4">
      <div class="flex flex-col md:flex-row gap-4">
        <div class="flex-1 relative">
          <input
            type="text"
            id="search-products"
            placeholder="Buscar productos por nombre, SKU o descripción..."
            class="w-full px-6 py-4 bg-white dark:bg-ktm-surface/90 backdrop-blur-sm rounded-lg border-2 border-gray-300 dark:border-ktm-border/50 text-gray-900 dark:text-ktm-text placeholder-gray-400 dark:placeholder-white/50 focus:border-ktm-accent focus:ring-2 focus:ring-ktm-accent/20 focus:outline-none transition-all uppercase tracking-wide text-sm shadow-sm dark:shadow-lg"
          />
          <div id="autocomplete-suggestions" class="hidden absolute z-50 w-full mt-1 bg-ktm-light-surface/95 dark:bg-ktm-surface/95 backdrop-blur-md rounded-lg border border-ktm-accent/30 shadow-xl max-h-60 overflow-y-auto"></div>
        </div>
        <button
          type="button"
          id="btn-buscar"
          class="px-8 py-4 bg-ktm-accent text-ktm-light-text dark:text-ktm-text font-bold hover:bg-ktm-accent-600 transition-all whitespace-nowrap uppercase tracking-wider"
        >
          Buscar
        </button>
      </div>
      
      <!-- Filtro por Categoría -->
      <div class="w-full md:w-auto">
        <label class="block text-ktm-light-text dark:text-ktm-text/70 text-xs mb-2 uppercase tracking-wider">Categoría</label>
        <select
          id="filter-categoria"
          class="w-full md:w-auto min-w-[200px] px-4 py-3 bg-white dark:bg-ktm-surface/90 backdrop-blur-sm rounded-lg border-2 border-gray-300 dark:border-ktm-border/50 text-gray-900 dark:text-ktm-text focus:border-ktm-accent focus:ring-2 focus:ring-ktm-accent/20 focus:outline-none transition-all cursor-pointer uppercase tracking-wide text-sm shadow-sm dark:shadow-lg"
        >
          <option value="all">Todas las categorías</option>
        </select>
      </div>
    </div>

    <!-- Botón Volver (oculto inicialmente) -->
    <button
      id="btn-volver"
      class="hidden mb-6 inline-flex items-center gap-2 px-6 py-3 bg-white dark:bg-ktm-surface/90 backdrop-blur-sm rounded-lg border-2 border-ktm-accent/50 dark:border-ktm-accent/30 text-gray-900 dark:text-ktm-text font-bold hover:border-ktm-accent hover:ring-2 hover:ring-ktm-accent/20 transition-all uppercase tracking-wider shadow-sm dark:shadow-lg"
    >
      <span>←</span> Volver a Categorías
    </button>

    <div id="products-list" class="space-y-4">
      <p class="text-ktm-light-text/70 dark:text-ktm-text/70">Cargando productos...</p>
    </div>

    <!-- Modal para crear/editar producto -->
    <div
      id="product-modal"
      class="fixed inset-0 bg-black/70 z-50 hidden items-center justify-center backdrop-blur-sm p-4"
    >
      <div class="bg-white dark:bg-gradient-to-b dark:from-gray-900 dark:to-gray-950 border-2 border-gray-300 dark:border-primary rounded-xl p-4 md:p-5 w-full max-w-sm sm:max-w-md md:max-w-lg lg:max-w-xl max-h-[85vh] overflow-y-auto shadow-2xl">
        <div class="flex items-center justify-between mb-3 border-b-2 border-gray-300 dark:border-primary pb-2">
          <h2 id="modal-title" class="text-lg md:text-xl font-bold text-gray-900 dark:text-ktm-text">Nuevo Producto</h2>
          <button id="close-modal" class="text-gray-600 dark:text-ktm-text/80 hover:text-gray-900 dark:hover:text-ktm-text text-xl md:text-2xl font-bold">✕</button>
        </div>

                <form id="product-form" class="space-y-3">
          <input type="hidden" id="product-id" />

          <div>
            <label for="product-name" class="block text-sm font-bold mb-2 text-gray-900 dark:text-ktm-text">Nombre</label>
            <input
              type="text"
              id="product-name"
              required
              class="w-full px-4 py-3 rounded-lg bg-gray-50 dark:bg-gray-800 border-2 border-gray-300 dark:border-primary/30 text-gray-900 dark:text-ktm-text placeholder-gray-400 dark:placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-ktm-accent/20 focus:border-ktm-accent"
              placeholder="Nombre del producto"
            />
          </div>

          <div>
            <label for="product-description" class="block text-sm font-bold mb-2 text-gray-900 dark:text-ktm-text">Descripción</label>
            <textarea
              id="product-description"
              rows="3"
              class="w-full px-4 py-3 rounded-lg bg-gray-50 dark:bg-gray-800 border-2 border-gray-300 dark:border-primary/30 text-gray-900 dark:text-ktm-text placeholder-gray-400 dark:placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-ktm-accent/20 focus:border-ktm-accent"
              placeholder="Descripción del producto"
            ></textarea>
          </div>

          <div>
            <label for="product-image-file" class="block text-sm font-bold mb-2 text-gray-900 dark:text-ktm-text">Imagen del Producto</label>
            <input
              type="file"
              id="product-image-file"
              accept="image/*"
              class="w-full px-4 py-3 rounded-lg bg-gray-800 border-2 border-primary/30 text-ktm-text file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-ktm-accent file:text-ktm-text hover:file:bg-ktm-accent-600"
            />
            <p class="text-xs text-gray-600 dark:text-ktm-text/60 mt-1">Selecciona una imagen desde tu dispositivo (opcional al editar - solo si quieres cambiar la imagen)</p>
            <div id="product-image-preview" class="mt-2 hidden">
              <img id="product-image-preview-img" src="" alt="Preview" class="max-w-xs rounded-lg border-2 border-primary/30" />
            </div>
            <input type="hidden" id="product-image-url" />
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="product-price" class="block text-sm font-bold mb-2 text-gray-900 dark:text-ktm-text">Precio</label>
              <input
                type="number"
                id="product-price"
                step="0.01"
                min="0"
                required
                class="w-full px-4 py-3 rounded-lg bg-gray-50 dark:bg-gray-800 border-2 border-gray-300 dark:border-primary/30 text-gray-900 dark:text-ktm-text placeholder-gray-400 dark:placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-ktm-accent/20 focus:border-ktm-accent"
                placeholder="0.00"
              />
            </div>

            <div>
              <label for="product-stock" class="block text-sm font-bold mb-2 text-gray-900 dark:text-ktm-text">Stock</label>
              <input
                type="number"
                id="product-stock"
                min="0"
                required
                class="w-full px-4 py-3 rounded-lg bg-gray-50 dark:bg-gray-800 border-2 border-gray-300 dark:border-primary/30 text-gray-900 dark:text-ktm-text placeholder-gray-400 dark:placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-ktm-accent/20 focus:border-ktm-accent"
                placeholder="0"
              />
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="product-status" class="block text-sm font-bold mb-2 text-gray-900 dark:text-ktm-text">Estado</label>
              <select
                id="product-status"
                class="w-full px-4 py-3 rounded-lg bg-gray-50 dark:bg-gray-800 border-2 border-gray-300 dark:border-primary/30 text-gray-900 dark:text-ktm-text focus:outline-none focus:ring-2 focus:ring-ktm-accent/20 focus:border-ktm-accent"
              >
                <option value="active">Activo</option>
                <option value="inactive">Inactivo</option>
              </select>
            </div>

            <div>
              <label for="product-category" class="block text-sm font-bold mb-2 text-gray-900 dark:text-ktm-text">Tipo</label>
              <select
                id="product-category"
                class="w-full px-4 py-3 rounded-lg bg-gray-50 dark:bg-gray-800 border-2 border-gray-300 dark:border-primary/30 text-gray-900 dark:text-ktm-text focus:outline-none focus:ring-2 focus:ring-ktm-accent/20 focus:border-ktm-accent"
              >
                <option value="accessory">Accesorio</option>
                <option value="spare_part">Repuesto</option>
              </select>
            </div>
          </div>

          <div class="flex items-center gap-3">
            <input
              type="checkbox"
              id="product-featured"
              class="w-5 h-5 rounded border-2 border-gray-300 dark:border-primary/30 text-ktm-accent focus:ring-2 focus:ring-ktm-accent/20 cursor-pointer"
            />
            <label for="product-featured" class="text-sm font-bold text-gray-900 dark:text-ktm-text cursor-pointer">
              Producto Destacado (aparecerá en la página de inicio)
            </label>
          </div>

          <div class="flex flex-col sm:flex-row gap-3">
            <button
              type="submit"
              class="flex-1 px-4 py-3 rounded-lg bg-ktm-accent text-ktm-text font-bold hover:bg-ktm-accent-600 transition-colors"
            >
              Guardar
            </button>
            <button
              type="button"
              id="cancel-form"
              class="flex-1 px-4 py-3 rounded-lg border-2 border-gray-300 dark:border-primary/30 text-gray-900 dark:text-ktm-text hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
            >
              Cancelar
            </button>
          </div>

          <p id="form-error" class="text-xs text-red-400 mt-2"></p>
        </form>
      </div>
    </div>
  </section>

  <script>
    // Usar Supabase desde el CDN (ya cargado en BaseLayout)
    let supabaseClient = null;
    
    function initSupabase() {
      if (typeof supabase === 'undefined') {
        setTimeout(initSupabase, 100);
        return;
      }
      
      const supabaseUrl = window.PUBLIC_SUPABASE_URL || 'https://prizpqahcluomioxnmex.supabase.co';
      const supabaseAnonKey = window.PUBLIC_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InByaXpwcWFoY2x1b21pb3hubWV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3OTIxNjIsImV4cCI6MjA3MzM2ODE2Mn0.7qJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJq';
      supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);
      
      // Inicializar funciones que dependen de supabaseClient
      loadProducts();
    }
    
    // Funciones de storage inline
    async function uploadImage(file: File, folder: string = 'products'): Promise<string> {
      if (!supabaseClient) throw new Error('Supabase client no disponible');
      const fileExt = file.name.split('.').pop();
      const fileName = `${Math.random()}.${fileExt}`;
      const filePath = `${folder}/${fileName}`;
      const { error: uploadError } = await supabaseClient.storage.from('product-images').upload(filePath, file);
      if (uploadError) throw uploadError;
      const { data } = supabaseClient.storage.from('product-images').getPublicUrl(filePath);
      return data.publicUrl;
    }
    
    async function deleteImage(imageUrl: string, folder: string = 'products'): Promise<void> {
      if (!supabaseClient) throw new Error('Supabase client no disponible');
      const urlParts = imageUrl.split('/');
      const fileName = urlParts[urlParts.length - 1];
      const filePath = `${folder}/${fileName}`;
      const { error } = await supabaseClient.storage.from('product-images').remove([filePath]);
      if (error) throw error;
    }

    let editingProductId: number | null = null;
    let selectedImageFile: File | null = null;

    async function checkAdminAccess() {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) {
        window.location.href = '/login?return=/admin/productos';
        return false;
      }

      const { data: profile } = await supabaseClient
        .from('users')
        .select('role')
        .eq('id', session.user.id)
        .single();

      if (profile?.role !== 'admin') {
        alert('No tienes permisos para acceder a esta página');
        window.location.href = '/';
        return false;
      }

      return true;
    }

    // Funciones de categorización (inline, igual que en tienda.astro)
    const CATEGORIES_INLINE = [
      { id: 'Aceites y Lubricantes', keywords: ['aceite', 'oil', 'lubricante', 'motorex', 'liqui moly', 'liquimoly', 'coolant', 'refrigerante', 'fork oil', 'chain lube', 'chainclean', 'brake clean'] },
      { id: 'Filtros', keywords: ['filtro', 'filter', 'aire', 'aceite', 'air'] },
      { id: 'Frenos', keywords: ['pastilla', 'freno', 'brake', 'disco', 'bomba de freno', 'bomba freno', 'caliper', 'calipe'] },
      { id: 'Motor', keywords: ['empaquetadura', 'gasket', 'piston', 'anillo', 'valvula', 'valvulas', 'reten', 'retenes', 'cigueñal', 'cigüeñal', 'culata', 'cilindro', 'juego anillos', 'kit piston'] },
      { id: 'Transmisión', keywords: ['cadena', 'chain', 'catalina', 'piñon', 'sprocket', 'candado', 'transmision', 'embrague'] },
      { id: 'Suspensión', keywords: ['horquilla', 'fork', 'resorte', 'spring', 'suspension', 'amortiguador', 'shock'] },
      { id: 'Eléctrico', keywords: ['relay', 'rele', 'regulador', 'voltage', 'voltaje', 'switch', 'cable', 'intermitente', 'señalizador'] },
      { id: 'Neumáticos y Cámaras', keywords: ['neumatico', 'tire', 'camara', 'mousse', 'aro'] },
      { id: 'Baterías', keywords: ['bateria', 'battery', 'ytx', 'ytz', 'ftx', 'ftz', 'litio'] },
      { id: 'Bujías', keywords: ['bujia', 'bujía', 'spark', 'ngk', 'bosch', 'cachimba'] },
      { id: 'Iluminación', keywords: ['ampolleta', 'bulb', 'foco', 'led', 'h3', 'h4', 'halogen'] },
      { id: 'Accesorios', keywords: ['protector', 'espejo', 'mirror', 'bolso', 'funda', 'manilla', 'manubrio', 'calienta puños', 'cubrepuños', 'phone case', 'bundle'] }
    ];

    function categorizeProduct(name: string): string {
      const nameLower = (name || '').toLowerCase();
      for (const category of CATEGORIES_INLINE) {
        for (const keyword of category.keywords) {
          if (nameLower.includes(keyword.toLowerCase())) {
            return category.id;
          }
        }
      }
      return 'Otros';
    }

    function getAvailableCategoriesInline(products: any[]): string[] {
      const categorySet = new Set<string>();
      products.forEach(p => {
        const category = categorizeProduct(p.name);
        if (category) categorySet.add(category);
      });
      return Array.from(categorySet).sort();
    }

    function filterByCategoryInline(products: any[], category: string): any[] {
      if (category === 'all') return products;
      return products.filter(p => categorizeProduct(p.name) === category);
    }

    function searchProductsInline(products: any[], searchText: string): any[] {
      if (!searchText.trim()) return products;
      const searchLower = searchText.toLowerCase().trim();
      return products.filter(p => {
        const name = (p.name || '').toLowerCase();
        const description = (p.description || '').toLowerCase();
        const sku = (p.sku || '').toLowerCase();
        return name.includes(searchLower) || description.includes(searchLower) || sku.includes(searchLower);
      });
    }

    function getAutocompleteSuggestionsInline(products: any[], searchText: string, limit: number = 5): string[] {
      if (!searchText.trim()) return [];
      const searchLower = searchText.toLowerCase().trim();
      const suggestions = new Set<string>();
      for (const product of products) {
        const name = (product.name || '').toLowerCase();
        if (name.includes(searchLower)) {
          suggestions.add(product.name);
          if (suggestions.size >= limit) break;
        }
      }
      return Array.from(suggestions).slice(0, limit);
    }

    // Función para obtener la imagen de una categoría
    function getCategoryImage(category: string): string {
      const categoryMap: Record<string, string> = {
        'Aceites y Lubricantes': 'aceitesylubricantes.png',
        'Filtros': 'filtros.png',
        'Frenos': 'frenos.png',
        'Motor': 'motor.png',
        'Transmisión': 'transmision.png',
        'Suspensión': 'suspension.png',
        'Eléctrico': 'electrico.png',
        'Neumáticos y Cámaras': 'NEUMATICOSYCAMARAS.png',
        'Baterías': 'baterias.png',
        'Bujías': 'bujias.png',
        'Iluminación': 'iluminacion.png',
        'Accesorios': 'accesorios.png',
        'Otros': 'otros-repuestos.png'
      };
      const imageName = categoryMap[category] || 'otros-repuestos.png';
      return `/accesorios-repuestos/${imageName}`;
    }

    let allProducts: any[] = [];
    let currentCategory = 'all';
    let currentSearch = '';
    let viewMode: 'categories' | 'products' = 'categories';

    async function loadProducts() {
      if (!supabaseClient) {
        console.error('❌ Cliente de Supabase no disponible');
        return;
      }
      
      const hasAccess = await checkAdminAccess();
      if (!hasAccess) return;

      try {
        const { data, error } = await supabaseClient
          .from('products')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) {
          console.error('Error cargando productos:', error);
          throw error;
        }

        allProducts = data || [];
        
        // Actualizar select de categorías
        const categorySelect = document.getElementById('filter-categoria') as HTMLSelectElement;
        if (categorySelect) {
          const availableCategories = getAvailableCategoriesInline(allProducts);
          categorySelect.innerHTML = '<option value="all">Todas las categorías</option>';
          availableCategories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            categorySelect.appendChild(option);
          });
        }

        renderView();
      } catch (err) {
        console.error('Error cargando productos:', err);
      }
    }
    
    // Inicializar cuando el DOM esté listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initSupabase);
    } else {
      initSupabase();
    }

    function renderView() {
      const listEl = document.getElementById('products-list')!;
      const btnVolver = document.getElementById('btn-volver')!;
      const resultCount = document.getElementById('result-count')!;
      const resultCountPlural = document.getElementById('result-count-plural')!;

      if (!allProducts || allProducts.length === 0) {
        listEl.innerHTML = '<p class="text-ktm-light-text/70 dark:text-ktm-text/70">No hay productos</p>';
        if (resultCount) resultCount.textContent = '0';
        return;
      }

      // Si no hay filtros activos, mostrar cards de categorías
      if (currentCategory === 'all' && !currentSearch.trim() && viewMode === 'categories') {
        btnVolver.classList.add('hidden');
        renderCategoryCards();
        return;
      }

      // Mostrar productos filtrados
      btnVolver.classList.remove('hidden');
      viewMode = 'products';
      
      let filtered = [...allProducts];
      
      if (currentCategory !== 'all') {
        filtered = filterByCategoryInline(filtered, currentCategory);
      }
      
      if (currentSearch.trim()) {
        filtered = searchProductsInline(filtered, currentSearch);
      }

      if (resultCount) {
        resultCount.textContent = filtered.length.toString();
        resultCountPlural.textContent = filtered.length !== 1 ? 's' : '';
      }

      if (filtered.length === 0) {
        listEl.innerHTML = '<p class="text-ktm-light-text/70 dark:text-ktm-text/70 text-center py-12">No se encontraron productos con los filtros seleccionados.</p>';
        return;
      }

      renderProductsList(filtered);
    }

    function renderCategoryCards() {
      const listEl = document.getElementById('products-list')!;
      const resultCount = document.getElementById('result-count')!;
      const resultCountPlural = document.getElementById('result-count-plural')!;

      const categories = getAvailableCategoriesInline(allProducts);
      
      if (categories.length === 0) {
        listEl.innerHTML = '<p class="text-ktm-light-text/70 dark:text-ktm-text/70">No hay categorías disponibles.</p>';
        return;
      }

      const grid = document.createElement('div');
      grid.className = 'grid sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 md:gap-8';

      categories.forEach(category => {
        const categoryProducts = filterByCategoryInline(allProducts, category);
        const featuredInCategory = categoryProducts.filter((p: any) => p.featured).length;
        const card = document.createElement('div');
        card.className = 'relative overflow-hidden bg-ktm-light-surface/80 dark:bg-ktm-surface/80 backdrop-blur-sm rounded-xl hover:shadow-xl transition-all cursor-pointer group min-h-[280px]';
        card.addEventListener('click', () => {
          currentCategory = category;
          const categorySelect = document.getElementById('filter-categoria') as HTMLSelectElement;
          if (categorySelect) categorySelect.value = category;
          viewMode = 'products';
          renderView();
        });
        
        const categoryImage = getCategoryImage(category);
        
        card.innerHTML = `
          <div class="absolute inset-0 bg-cover bg-center transition-opacity opacity-100 dark:opacity-80 group-hover:opacity-100 dark:group-hover:opacity-95" style="background-image: url('${categoryImage}');"></div>
          <div class="absolute inset-0 bg-gradient-to-t from-ktm-bg/40 via-ktm-bg/20 to-transparent"></div>
          <div class="relative z-10 h-full flex flex-col justify-center items-center p-6 text-center">
            <h3 class="text-2xl md:text-3xl font-black text-white mb-2 uppercase tracking-tight drop-shadow-2xl" style="text-shadow: 2px 2px 8px rgba(0,0,0,0.8), 0 0 20px rgba(0,0,0,0.5), 0 0 30px rgba(255,255,255,0.3), 0 0 40px rgba(255,255,255,0.2); filter: brightness(1.1);">${category}</h3>
            <p class="text-white/90 text-sm uppercase tracking-wider drop-shadow-lg mb-1" style="text-shadow: 1px 1px 4px rgba(0,0,0,0.8), 0 0 10px rgba(0,0,0,0.5);">${categoryProducts.length} producto${categoryProducts.length !== 1 ? 's' : ''}</p>
            ${featuredInCategory > 0 ? `<p class="text-ktm-accent font-bold text-xs uppercase tracking-wider drop-shadow-lg flex items-center justify-center gap-1" style="text-shadow: 1px 1px 4px rgba(0,0,0,0.8);"><span>⭐</span> ${featuredInCategory} destacado${featuredInCategory !== 1 ? 's' : ''}</p>` : ''}
          </div>
        `;
        grid.appendChild(card);
      });
      
      listEl.innerHTML = '';
      listEl.appendChild(grid);
      
      if (resultCount) {
        resultCount.textContent = categories.length.toString();
        resultCountPlural.textContent = 'categorías';
      }
    }

    function renderProductsList(products: any[]) {
      const listEl = document.getElementById('products-list')!;
      
      const grid = document.createElement('div');
      grid.className = 'grid sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';

      products.forEach((p) => {
        const rawImageUrl = p.main_image_url;
        const hasImage = !!(rawImageUrl && String(rawImageUrl).trim() !== '' && rawImageUrl !== null && rawImageUrl !== undefined);
        const imageUrl = hasImage ? String(rawImageUrl).trim() : '';
        const productName = (p.name || 'Producto').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        
        const card = document.createElement('div');
        card.className = 'border-2 border-gray-300 dark:border-primary/30 rounded-xl p-4 bg-white dark:bg-ktm-surface/50 flex flex-col gap-4 shadow-lg backdrop-blur-sm hover:shadow-xl transition-all';
        
        card.innerHTML = `
          ${hasImage ? `
            <div class="w-full h-48 rounded-lg overflow-hidden border-2 border-primary/30 bg-gray-800">
              <img 
                src="${imageUrl}" 
                alt="${productName}" 
                class="w-full h-full object-cover"
                loading="lazy"
                crossorigin="anonymous"
                onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
              >
              <div class="w-full h-full hidden items-center justify-center text-ktm-text/50 text-xs bg-gray-700/50">
                Sin imagen
              </div>
            </div>
          ` : `
            <div class="w-full h-48 rounded-lg border-2 border-primary/30 bg-gray-800 flex items-center justify-center">
              <div class="text-gray-500 dark:text-ktm-text/50 text-xs">Sin imagen</div>
            </div>
          `}
          <div class="flex-1 flex flex-col gap-2">
            <div class="flex items-center gap-2 mb-1 flex-wrap">
              <h3 class="font-bold text-gray-900 dark:text-ktm-text text-lg line-clamp-2 flex-1 min-w-0">${productName}</h3>
              ${p.featured ? '<span class="px-2 py-1 bg-ktm-accent text-white dark:text-ktm-text text-xs font-bold uppercase rounded flex-shrink-0 flex items-center gap-1"><span>⭐</span> Destacado</span>' : ''}
            </div>
            <p class="text-sm text-gray-600 dark:text-ktm-text/70 line-clamp-2">${(p.description || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}</p>
            <div class="mt-auto pt-2 border-t border-gray-300 dark:border-primary/30">
              <p class="text-sm text-gray-600 dark:text-ktm-text/70 mb-3">
                <span class="font-bold text-ktm-accent">$${Number(p.price).toLocaleString('es-CL')}</span> | 
                Stock: <span class="font-semibold">${p.stock}</span> | 
                ${p.status === 'active' ? '<span class="text-green-600 dark:text-green-400">Activo</span>' : '<span class="text-red-600 dark:text-red-400">Inactivo</span>'}
                ${p.featured ? ' | <span class="text-ktm-accent font-bold">⭐ Destacado</span>' : ''}
              </p>
              <div class="flex gap-2">
                <button class="edit-product flex-1 px-4 py-2 rounded-lg bg-ktm-accent/20 hover:bg-ktm-accent/30 text-ktm-accent text-sm font-semibold transition-colors shadow-md hover:scale-105" data-id="${p.id}">Editar</button>
                <button class="delete-product flex-1 px-4 py-2 rounded-lg bg-red-500/20 hover:bg-red-500/30 text-sm text-red-400 font-semibold transition-colors shadow-md hover:scale-105" data-id="${p.id}">Eliminar</button>
              </div>
            </div>
          </div>
        `;
        
        grid.appendChild(card);
      });

      listEl.innerHTML = '';
      listEl.appendChild(grid);

      // Agregar event listeners
      document.querySelectorAll('.edit-product').forEach((btn) => {
        btn.addEventListener('click', (e) => {
          const id = Number((e.target as HTMLElement).getAttribute('data-id'));
          editProduct(id, allProducts.find((p) => p.id === id)!);
        });
      });

      document.querySelectorAll('.delete-product').forEach((btn) => {
        btn.addEventListener('click', async (e) => {
          const id = Number((e.target as HTMLElement).getAttribute('data-id'));
          if (confirm('¿Estás seguro de eliminar este producto?')) {
            await deleteProduct(id);
          }
        });
      });
    }

    function openModal(isEdit = false) {
      const modal = document.getElementById('product-modal')!;
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      document.getElementById('modal-title')!.textContent = isEdit ? 'Editar Producto' : 'Nuevo Producto';
      
      // Solo resetear si NO es edición
      if (!isEdit) {
        editingProductId = null;
        selectedImageFile = null;
        (document.getElementById('product-form') as HTMLFormElement).reset();
        document.getElementById('product-image-preview')!.classList.add('hidden');
      }
    }

    function closeModal() {
      const modal = document.getElementById('product-modal')!;
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      editingProductId = null;
      selectedImageFile = null;
      // Limpiar el formulario al cerrar
      (document.getElementById('product-form') as HTMLFormElement).reset();
      document.getElementById('product-image-preview')!.classList.add('hidden');
    }

    function editProduct(id: number, product: any) {
      // Primero abrir el modal
      openModal(true);
      
      // Luego llenar los campos con los datos del producto
      editingProductId = id;
      selectedImageFile = null;
      
      // Limpiar el input de archivo
      const fileInput = document.getElementById('product-image-file') as HTMLInputElement;
      if (fileInput) fileInput.value = '';
      
      // Llenar todos los campos con los datos del producto
      (document.getElementById('product-id') as HTMLInputElement).value = id.toString();
      (document.getElementById('product-name') as HTMLInputElement).value = product.name || '';
      (document.getElementById('product-description') as HTMLTextAreaElement).value = product.description || '';
      (document.getElementById('product-image-url') as HTMLInputElement).value = product.main_image_url || '';
      (document.getElementById('product-price') as HTMLInputElement).value = product.price?.toString() || '0';
      (document.getElementById('product-stock') as HTMLInputElement).value = product.stock?.toString() || '0';
      (document.getElementById('product-status') as HTMLSelectElement).value = product.status || 'active';
      
      // Determinar el tipo de producto
      const categoryValue = product.is_accessory ? 'accessory' : (product.is_spare_part ? 'spare_part' : 'accessory');
      (document.getElementById('product-category') as HTMLSelectElement).value = categoryValue;
      
      // Cargar el valor de featured
      (document.getElementById('product-featured') as HTMLInputElement).checked = product.featured || false;
      
      // Mostrar preview de imagen existente
      if (product.main_image_url) {
        const previewEl = document.getElementById('product-image-preview')!;
        const previewImg = document.getElementById('product-image-preview-img') as HTMLImageElement;
        previewImg.src = product.main_image_url;
        previewEl.classList.remove('hidden');
      } else {
        document.getElementById('product-image-preview')!.classList.add('hidden');
      }
    }

    async function deleteProduct(id: number) {
      try {
        // Primero obtener el producto para eliminar su imagen
        const { data: product } = await supabaseClient
          .from('products')
          .select('main_image_url')
          .eq('id', id)
          .single();

        // Eliminar el producto de la base de datos
        const { error } = await supabaseClient.from('products').delete().eq('id', id);
        if (error) throw error;

        // Eliminar la imagen del storage si existe
        if (product?.main_image_url) {
          try {
            await deleteImage(product.main_image_url, 'products');
          } catch (imgErr) {
            console.warn('No se pudo eliminar la imagen del storage:', imgErr);
          }
        }

        loadProducts();
      } catch (err) {
        alert('Error al eliminar producto');
        console.error(err);
      }
    }

    // Manejar selección de imagen
    document.getElementById('product-image-file')?.addEventListener('change', (e) => {
      const file = (e.target as HTMLInputElement).files?.[0];
      if (file) {
        selectedImageFile = file;
        const reader = new FileReader();
        reader.onload = (event) => {
          const previewEl = document.getElementById('product-image-preview')!;
          const previewImg = document.getElementById('product-image-preview-img') as HTMLImageElement;
          previewImg.src = event.target?.result as string;
          previewEl.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      }
    });

    // Event listeners para búsqueda y filtros
    const searchInput = document.getElementById('search-products') as HTMLInputElement;
    const btnBuscar = document.getElementById('btn-buscar');
    const categorySelect = document.getElementById('filter-categoria') as HTMLSelectElement;
    const autocompleteDiv = document.getElementById('autocomplete-suggestions');
    const btnVolver = document.getElementById('btn-volver');

    // Búsqueda con autocompletado
    if (searchInput) {
      let autocompleteTimeout: any;
      
      const showSuggestions = (value: string) => {
        clearTimeout(autocompleteTimeout);
        if (value.trim() && autocompleteDiv) {
          autocompleteTimeout = setTimeout(() => {
            const suggestions = getAutocompleteSuggestionsInline(allProducts, value, 5);
            showAutocomplete(suggestions);
          }, 200);
        } else {
          hideAutocomplete();
        }
      };
      
      searchInput.addEventListener('input', (e) => {
        const value = (e.target as HTMLInputElement).value;
        currentSearch = value;
        showSuggestions(value);
        renderView();
      });
      
      searchInput.addEventListener('focus', (e) => {
        const value = (e.target as HTMLInputElement).value;
        showSuggestions(value);
      });

      searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          renderView();
          hideAutocomplete();
        }
      });

      document.addEventListener('click', (e) => {
        if (autocompleteDiv && !autocompleteDiv.contains(e.target as Node) && e.target !== searchInput) {
          hideAutocomplete();
        }
      });
    }

    // Botón buscar
    if (btnBuscar) {
      btnBuscar.addEventListener('click', () => {
        renderView();
        hideAutocomplete();
      });
    }

    function showAutocomplete(suggestions: string[]) {
      if (!autocompleteDiv) return;
      if (suggestions.length === 0) {
        hideAutocomplete();
        return;
      }
      autocompleteDiv.innerHTML = '';
      autocompleteDiv.classList.remove('hidden');
      suggestions.forEach(suggestion => {
        const item = document.createElement('div');
        item.className = 'px-4 py-2 text-ktm-light-text dark:text-ktm-text hover:bg-ktm-accent/30 cursor-pointer transition-colors border-b border-ktm-accent/20 last:border-b-0';
        item.textContent = suggestion;
        item.addEventListener('click', () => {
          if (searchInput) {
            searchInput.value = suggestion;
            currentSearch = suggestion;
            hideAutocomplete();
            renderView();
          }
        });
        autocompleteDiv.appendChild(item);
      });
    }

    function hideAutocomplete() {
      if (autocompleteDiv) {
        autocompleteDiv.classList.add('hidden');
      }
    }

    // Filtro de categoría
    if (categorySelect) {
      categorySelect.addEventListener('change', (e) => {
        currentCategory = (e.target as HTMLSelectElement).value;
        renderView();
      });
    }

    // Botón volver
    if (btnVolver) {
      btnVolver.addEventListener('click', () => {
        currentCategory = 'all';
        currentSearch = '';
        if (categorySelect) categorySelect.value = 'all';
        if (searchInput) searchInput.value = '';
        viewMode = 'categories';
        renderView();
      });
    }

    document.getElementById('new-product-btn')?.addEventListener('click', () => openModal());
    document.getElementById('close-modal')?.addEventListener('click', closeModal);
    document.getElementById('cancel-form')?.addEventListener('click', closeModal);

    // Función para generar slug a partir del nombre
    function generateSlug(name: string): string {
      return name
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '') // Eliminar acentos
        .replace(/[^a-z0-9]+/g, '-') // Reemplazar caracteres especiales con guiones
        .replace(/^-+|-+$/g, '') // Eliminar guiones al inicio y final
        .substring(0, 100); // Limitar longitud
    }

    // Función para generar slug único
    async function generateUniqueSlug(baseName: string, excludeId?: number): Promise<string> {
      let slug = generateSlug(baseName);
      let counter = 0;
      let isUnique = false;

      while (!isUnique) {
        let query = supabaseClient
          .from('products')
          .select('id')
          .eq('slug', slug);
        
        if (excludeId) {
          query = query.neq('id', excludeId);
        }

        const { data, error } = await query.limit(1);

        if (error) throw error;

        if (!data || data.length === 0) {
          isUnique = true;
        } else {
          counter++;
          slug = `${generateSlug(baseName)}-${counter}`;
        }
      }

      return slug;
    }

    document.getElementById('product-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target as HTMLFormElement;
      const errorEl = document.getElementById('form-error')!;
      const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;

      try {
        submitBtn.disabled = true;
        errorEl.textContent = '';

        let imageUrl = (document.getElementById('product-image-url') as HTMLInputElement).value || null;

        // Si hay un archivo seleccionado, subirlo primero
        if (selectedImageFile) {
          errorEl.textContent = 'Subiendo imagen...';
          imageUrl = await uploadImage(selectedImageFile, 'products');
        }

        const productName = (form.querySelector('#product-name') as HTMLInputElement).value;
        
        // Generar slug único solo para productos nuevos
        let slug: string;
        if (editingProductId) {
          // Si estamos editando, mantener el slug existente
          const { data: existingProduct } = await supabaseClient
            .from('products')
            .select('slug')
            .eq('id', editingProductId)
            .single();
          
          slug = existingProduct?.slug || await generateUniqueSlug(productName, editingProductId);
        } else {
          // Si es un producto nuevo, generar slug único
          errorEl.textContent = 'Generando slug...';
          slug = await generateUniqueSlug(productName);
        }

        const data: any = {
          name: productName,
          slug: slug,
          description: (form.querySelector('#product-description') as HTMLTextAreaElement).value || null,
          price: Number((form.querySelector('#product-price') as HTMLInputElement).value),
          stock: Number((form.querySelector('#product-stock') as HTMLInputElement).value),
          status: (form.querySelector('#product-status') as HTMLSelectElement).value,
          is_accessory: (form.querySelector('#product-category') as HTMLSelectElement).value === 'accessory',
          is_spare_part: (form.querySelector('#product-category') as HTMLSelectElement).value === 'spare_part',
          featured: (document.getElementById('product-featured') as HTMLInputElement).checked || false,
        };

        // Solo actualizar la imagen si se seleccionó una nueva o si es un producto nuevo
        if (imageUrl) {
          data.main_image_url = imageUrl;
        } else if (!editingProductId) {
          // Si es un producto nuevo y no hay imagen, requerir imagen
          throw new Error('Debes seleccionar una imagen para el producto');
        }
        // Si es edición y no hay nueva imagen, mantener la imagen existente (no incluir main_image_url en el update)

        if (editingProductId) {
          // Si estamos editando y hay una nueva imagen, eliminar la imagen anterior
          if (imageUrl && selectedImageFile) {
            const oldImageUrl = (document.getElementById('product-image-url') as HTMLInputElement).value;
            if (oldImageUrl && oldImageUrl !== imageUrl) {
              try {
                await deleteImage(oldImageUrl, 'products');
              } catch (imgErr) {
                console.warn('No se pudo eliminar la imagen anterior:', imgErr);
              }
            }
          }

          const { error } = await supabaseClient
            .from('products')
            .update(data)
            .eq('id', editingProductId);
          if (error) throw error;
        } else {
          const { error } = await supabaseClient.from('products').insert(data);
          if (error) throw error;
        }

        closeModal();
        loadProducts();
      } catch (err: any) {
        errorEl.textContent = err.message || 'Error al guardar producto';
      } finally {
        submitBtn.disabled = false;
      }
    });

    document.addEventListener('DOMContentLoaded', loadProducts);
  </script>
</BaseLayout>


