---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="Iniciar sesi√≥n - Mimoto">
  <section class="max-w-md mx-auto px-4 py-12 md:py-16">
    <div class="text-center mb-8">
      <h1 class="text-4xl md:text-5xl font-bold text-ktm-light-text dark:text-white mb-2">Iniciar sesi√≥n</h1>
      <p class="text-ktm-light-text/80 dark:text-white/80">Accede a tu cuenta</p>
    </div>

    <form id="login-form" class="space-y-6 bg-white dark:bg-gray-900/50 border-2 border-ktm-light-border dark:border-primary rounded-xl p-8 shadow-lg backdrop-blur-sm">
      <div>
        <label for="email" class="block text-sm font-bold text-ktm-light-text dark:text-white mb-2">Email</label>
        <input
          type="email"
          id="email"
          name="email"
          required
          class="w-full px-4 py-3 rounded-lg bg-gray-50 dark:bg-gray-800 border-2 border-gray-300 dark:border-primary/30 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-ktm-accent dark:focus:ring-primary focus:border-ktm-accent dark:focus:border-primary placeholder-gray-400 dark:placeholder-white/40"
          placeholder="tu@email.com"
        />
      </div>

      <div>
        <label for="password" class="block text-sm font-bold text-ktm-light-text dark:text-white mb-2">Contrase√±a</label>
        <input
          type="password"
          id="password"
          name="password"
          required
          class="w-full px-4 py-3 rounded-lg bg-gray-50 dark:bg-gray-800 border-2 border-gray-300 dark:border-primary/30 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-ktm-accent dark:focus:ring-primary focus:border-ktm-accent dark:focus:border-primary placeholder-gray-400 dark:placeholder-white/40"
          placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
        />
      </div>

      <button
        type="submit"
        class="w-full px-6 py-3 rounded-lg bg-ktm-accent dark:bg-primary text-white font-bold hover:bg-ktm-accentSoft dark:hover:bg-primary-600 transition-colors shadow-md text-lg"
      >
        Iniciar sesi√≥n
      </button>

      <p id="login-error" class="text-xs text-red-600 dark:text-red-400 text-center"></p>
    </form>

    <div class="mt-6 text-center text-sm text-ktm-light-text/80 dark:text-white/80">
      <p>¬øNo tienes cuenta?</p>
      <a href="/registro" class="text-ktm-accent dark:text-primary hover:text-ktm-accentSoft dark:hover:text-primary-400 font-bold">Reg√≠strate aqu√≠</a>
    </div>

    <div class="mt-6">
      <div class="relative">
        <div class="absolute inset-0 flex items-center">
          <div class="w-full border-t border-gray-300 dark:border-gray-300"></div>
        </div>
        <div class="relative flex justify-center text-sm">
          <span class="px-2 bg-white dark:bg-gray-950 text-ktm-light-text/60 dark:text-white/60">O contin√∫a con</span>
        </div>
      </div>
      <button
        id="google-login"
        type="button"
        class="mt-4 w-full px-6 py-3 rounded-lg border-2 border-gray-300 dark:border-primary/30 text-ktm-light-text dark:text-white font-bold hover:bg-gray-50 dark:hover:bg-primary/10 transition-colors shadow-lg"
      >
        <span class="flex items-center justify-center gap-2">
          <svg class="w-5 h-5" viewBox="0 0 24 24">
            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
          </svg>
          Continuar con Google
        </span>
      </button>
    </div>
  </section>

  <!-- Supabase ya se carga en BaseLayout, pero lo cargamos aqu√≠ tambi√©n por si acaso -->
  <script>
    // Verificar si Supabase ya est√° cargado desde BaseLayout
    if (typeof supabase === 'undefined') {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
      script.onload = function() {
        window.supabaseLoaded = true;
        console.log('‚úÖ Supabase cargado en login.astro');
      };
      script.onerror = function() {
        console.error('‚ùå Error cargando Supabase desde CDN');
      };
      document.head.appendChild(script);
    } else {
      console.log('‚úÖ Supabase ya est√° disponible desde BaseLayout');
    }
  </script>
  <script>
    // Valores hardcodeados como fallback
    const SUPABASE_URL = 'https://prizpqahcluomioxnmex.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InByaXpwcWFoY2x1b21pb3hubWV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3OTIxNjIsImV4cCI6MjA3MzM2ODE2Mn0.7qJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJq';
    
    let supabaseClient = null;
    let supabaseUrl = SUPABASE_URL;
    let supabaseAnonKey = SUPABASE_KEY;
    let supabaseLoadAttempts = 0;
    const MAX_ATTEMPTS = 100; // 10 segundos m√°ximo
    
    // Esperar a que Supabase se cargue desde el CDN
    function initLogin() {
      // Verificar que Supabase est√© disponible
      if (typeof supabase === 'undefined') {
        supabaseLoadAttempts++;
        if (supabaseLoadAttempts > MAX_ATTEMPTS) {
          console.error('‚ùå Timeout: Supabase no se carg√≥ despu√©s de', MAX_ATTEMPTS * 100, 'ms');
          console.error('‚ùå Intentando cargar Supabase manualmente...');
          // Intentar cargar el script manualmente
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
          script.onload = function() {
            console.log('‚úÖ Supabase cargado manualmente');
            window.supabaseLoaded = true;
            initLogin();
          };
          script.onerror = function() {
            console.error('‚ùå Error cargando Supabase desde CDN');
            alert('Error: No se pudo cargar Supabase. Por favor, recarga la p√°gina.');
          };
          document.head.appendChild(script);
          return;
        }
        if (supabaseLoadAttempts % 10 === 0) {
          console.log('‚è≥ Esperando a que Supabase se cargue... (intento', supabaseLoadAttempts, '/', MAX_ATTEMPTS, ')');
        }
        setTimeout(initLogin, 100);
        return;
      }
      
      console.log('‚úÖ Supabase cargado correctamente');
      
      // Intentar obtener de window primero, luego usar fallback
      if (typeof window !== 'undefined' && window.PUBLIC_SUPABASE_URL) {
        supabaseUrl = window.PUBLIC_SUPABASE_URL;
      }
      if (typeof window !== 'undefined' && window.PUBLIC_SUPABASE_ANON_KEY) {
        supabaseAnonKey = window.PUBLIC_SUPABASE_ANON_KEY;
      }
      
      console.log('üîß Inicializando login...');
      
      supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey, {
        auth: {
          persistSession: true,
          autoRefreshToken: true,
          detectSessionInUrl: true
        }
      });
      
      console.log('‚úÖ Cliente de Supabase inicializado');

      function setupLogin() {
        const loginForm = document.getElementById('login-form');
        const googleBtn = document.getElementById('google-login');
        const errorEl = document.getElementById('login-error');
        
        if (!loginForm) {
          console.error('‚ùå Formulario no encontrado');
          return;
        }
        
        console.log('‚úÖ Configurando login...');
        
        loginForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('üìù Formulario enviado');
          
          const emailInput = document.getElementById('email');
          const passwordInput = document.getElementById('password');
          const submitBtn = loginForm.querySelector('button[type="submit"]');
          
          if (!emailInput || !passwordInput) {
            console.error('‚ùå Campos no encontrados');
            if (errorEl) errorEl.textContent = 'Error: Campos no encontrados';
            return;
          }
          
          const email = emailInput.value ? String(emailInput.value).trim() : '';
          const password = passwordInput.value ? String(passwordInput.value) : '';
          
          if (!email || !password) {
            if (errorEl) errorEl.textContent = 'Por favor, completa todos los campos';
            return;
          }
          
          if (errorEl) errorEl.textContent = '';
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Iniciando sesi√≥n...';
          }
          
          try {
            console.log('üîê Iniciando sesi√≥n con:', email);
            console.log('üîß Cliente Supabase:', supabaseClient ? 'Disponible' : 'No disponible');
            
            const result = await supabaseClient.auth.signInWithPassword({ 
              email: email, 
              password: password 
            });
            
            const data = result.data;
            const error = result.error;
            
            console.log('üìã Respuesta de signInWithPassword:', {
              hasData: !!data,
              hasUser: !!(data && data.user),
              hasError: !!error,
              errorMessage: error ? error.message : null
            });
            
            if (error) {
              console.error('‚ùå Error de Supabase:', error);
              throw error;
            }
            
            if (!data || !data.user) {
              console.error('‚ùå No se recibi√≥ informaci√≥n del usuario');
              throw new Error('No se recibi√≥ informaci√≥n del usuario');
            }
            
            console.log('‚úÖ Login exitoso:', data.user.email);
            
            // Esperar un momento antes de verificar la sesi√≥n
            await new Promise(function(resolve) { setTimeout(resolve, 300); });
            
            const sessionResult = await supabaseClient.auth.getSession();
            const sessionData = sessionResult.data;
            const sessionError = sessionResult.error;
            
            if (sessionError) {
              console.error('‚ùå Error obteniendo sesi√≥n:', sessionError);
              throw new Error('Error al obtener la sesi√≥n: ' + sessionError.message);
            }
            
            if (!sessionData || !sessionData.session) {
              console.error('‚ùå La sesi√≥n no se guard√≥');
              throw new Error('La sesi√≥n no se guard√≥ correctamente. Por favor, intenta nuevamente.');
            }
            
            console.log('üìã Sesi√≥n guardada correctamente');
            
            // Verificar la sesi√≥n una vez m√°s antes de redirigir
            const finalSessionCheck = await supabaseClient.auth.getSession();
            if (finalSessionCheck.data && finalSessionCheck.data.session) {
              console.log('‚úÖ Sesi√≥n confirmada antes de redirigir');
              console.log('‚úÖ User ID:', finalSessionCheck.data.session.user.id);
              console.log('‚úÖ User Email:', finalSessionCheck.data.session.user.email);
            } else {
              console.error('‚ùå Sesi√≥n no encontrada en verificaci√≥n final');
              throw new Error('La sesi√≥n no se guard√≥ correctamente');
            }
            
            // Esperar un poco m√°s antes de redirigir para asegurar que la sesi√≥n se guarde
            await new Promise(function(resolve) { setTimeout(resolve, 500); });
            
            // Verificar una vez m√°s que la sesi√≥n est√© guardada
            const finalCheck = await supabaseClient.auth.getSession();
            if (!finalCheck.data?.session) {
              console.error('‚ùå La sesi√≥n no se guard√≥ correctamente');
              throw new Error('La sesi√≥n no se guard√≥ correctamente. Por favor, intenta nuevamente.');
            }
            
            console.log('‚úÖ Sesi√≥n confirmada antes de redirigir');
            
            const returnUrl = new URLSearchParams(window.location.search).get('return') || '/';
            console.log('üîÑ Redirigiendo a:', returnUrl);
            
            // Usar href en lugar de replace para permitir que el navegador maneje la navegaci√≥n correctamente
            window.location.href = returnUrl;
          } catch (err) {
            console.error('‚ùå Error completo en login:', err);
            
            let errorMessage = 'Error al iniciar sesi√≥n';
            if (err && typeof err === 'object' && err.message) {
              errorMessage = err.message;
            } else if (typeof err === 'string') {
              errorMessage = err;
            }
            
            if (errorEl) errorEl.textContent = errorMessage;
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.textContent = 'Iniciar sesi√≥n';
            }
          }
        });
        
        if (googleBtn) {
          googleBtn.addEventListener('click', async function() {
            if (errorEl) errorEl.textContent = '';
            
            // Verificar que el cliente est√© disponible
            if (!supabaseClient) {
              console.error('‚ùå Cliente de Supabase no disponible para Google login');
              if (errorEl) errorEl.textContent = 'Error: Supabase no est√° disponible. Por favor, recarga la p√°gina.';
              return;
            }
            
            try {
              console.log('üîê Iniciando sesi√≥n con Google...');
              const result = await supabaseClient.auth.signInWithOAuth({
                provider: 'google',
                options: { 
                  redirectTo: window.location.origin + '/auth/callback',
                  queryParams: {
                    access_type: 'offline',
                    prompt: 'consent',
                  }
                }
              });
              
              if (result.error) {
                console.error('‚ùå Error en signInWithOAuth:', result.error);
                throw result.error;
              }
              
              console.log('‚úÖ Redirigiendo a Google...', result);
              // La redirecci√≥n se hace autom√°ticamente
            } catch (err) {
              console.error('‚ùå Error Google:', err);
              if (errorEl) {
                const errorMsg = err && typeof err === 'object' && err.message ? err.message : 'Error con Google';
                errorEl.textContent = errorMsg;
              }
            }
          });
        }
      }
      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setupLogin);
      } else {
        setupLogin();
      }
    }
    
    // Inicializar cuando Supabase est√© listo
    // Verificar si el script del CDN ya se carg√≥
    function checkSupabaseAndInit() {
      if (typeof supabase !== 'undefined') {
        console.log('‚úÖ Supabase ya est√° disponible');
        initLogin();
      } else {
        // Esperar un poco m√°s y verificar
        setTimeout(function() {
          if (typeof supabase !== 'undefined') {
            console.log('‚úÖ Supabase cargado despu√©s de esperar');
            initLogin();
          } else {
            console.log('‚è≥ Iniciando espera de Supabase...');
            initLogin();
          }
        }, 200);
      }
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', checkSupabaseAndInit);
    } else {
      checkSupabaseAndInit();
    }
  </script>
</BaseLayout>
