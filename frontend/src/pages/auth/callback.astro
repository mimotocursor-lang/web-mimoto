---
import BaseLayout from '../../layouts/BaseLayout.astro';
---

<BaseLayout title="Autenticando... - Mimoto">
  <section class="max-w-md mx-auto px-4 py-16 text-center">
    <div class="bg-white border-2 border-primary rounded-xl p-8 shadow-lg">
      <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-primary/10 mb-4">
        <svg class="w-8 h-8 text-primary animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
      </div>
      <p class="text-gray-700 font-semibold">Procesando autenticaci√≥n...</p>
    </div>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Esperar a que Supabase se cargue desde el CDN
    let supabaseClient = null;
    let supabaseLoadAttempts = 0;
    const MAX_ATTEMPTS = 50;
    
    function initSupabase() {
      if (typeof supabase === 'undefined') {
        supabaseLoadAttempts++;
        if (supabaseLoadAttempts > MAX_ATTEMPTS) {
          console.error('‚ùå Timeout: Supabase no se carg√≥');
          window.location.href = '/login?error=Error cargando Supabase';
          return;
        }
        setTimeout(initSupabase, 100);
        return;
      }
      
      // Obtener variables con m√∫ltiples fallbacks
      const supabaseUrl = 
        (typeof window !== 'undefined' && window.PUBLIC_SUPABASE_URL) ||
        'https://prizpqahcluomioxnmex.supabase.co';
      
      const supabaseAnonKey = 
        (typeof window !== 'undefined' && window.PUBLIC_SUPABASE_ANON_KEY) ||
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InByaXpwcWFoY2x1b21pb3hubWV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3OTIxNjIsImV4cCI6MjA3MzM2ODE2Mn0.7qJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJq';
      
      supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey, {
        auth: {
          persistSession: true,
          autoRefreshToken: true,
          detectSessionInUrl: true,
          storage: typeof window !== 'undefined' ? window.localStorage : undefined
        }
      });
      
      console.log('‚úÖ Supabase inicializado en callback');
      handleAuthCallback();
    }

    async function handleAuthCallback() {
      console.log('üîÑ Procesando callback de autenticaci√≥n...');
      console.log('üìç URL actual:', window.location.href);
      console.log('üìç Hash:', window.location.hash);
      console.log('üìç Search:', window.location.search);

      try {
        // Primero, intentar intercambiar el c√≥digo por la sesi√≥n si viene en el hash
        if (window.location.hash) {
          const hashParams = new URLSearchParams(window.location.hash.substring(1));
          const accessToken = hashParams.get('access_token');
          const refreshToken = hashParams.get('refresh_token');
          
          if (accessToken && refreshToken) {
            console.log('üîë Tokens encontrados en hash, estableciendo sesi√≥n...');
            const { data, error: setSessionError } = await supabaseClient.auth.setSession({
              access_token: accessToken,
              refresh_token: refreshToken
            });
            
            if (setSessionError) {
              console.error('‚ùå Error estableciendo sesi√≥n:', setSessionError);
              window.location.href = `/login?error=${encodeURIComponent(setSessionError.message)}`;
              return;
            }
            
            if (data.session) {
              console.log('‚úÖ Sesi√≥n establecida desde hash');
            }
          }
        }

        // Obtener la sesi√≥n actual
        const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();

        if (sessionError) {
          console.error('‚ùå Error obteniendo sesi√≥n:', sessionError);
          window.location.href = `/login?error=${encodeURIComponent(sessionError.message)}`;
          return;
        }

        if (session?.user) {
          console.log('‚úÖ Sesi√≥n obtenida:', session.user.email);
          
          // Crear o actualizar perfil de usuario
          try {
            const { data: existingUser } = await supabaseClient
              .from('users')
              .select('id')
              .eq('id', session.user.id)
              .single();

            if (!existingUser) {
              console.log('üìù Creando perfil de usuario...');
              const { error: insertError } = await supabaseClient.from('users').insert({
                id: session.user.id,
                email: session.user.email,
                full_name: session.user.user_metadata?.full_name || session.user.user_metadata?.name || '',
                role: 'buyer',
              });

              if (insertError && !insertError.message.includes('duplicate')) {
                console.error('‚ö†Ô∏è Error creando perfil:', insertError);
              }
            }
          } catch (profileError) {
            console.error('‚ö†Ô∏è Error con perfil de usuario:', profileError);
            // Continuar aunque falle el perfil
          }

          // Esperar un momento para asegurar que la sesi√≥n se guarde
          await new Promise(resolve => setTimeout(resolve, 500));

          const returnUrl = new URLSearchParams(window.location.search).get('return') || '/';
          console.log('üîÑ Redirigiendo a:', returnUrl);
          window.location.href = returnUrl;
        } else {
          console.error('‚ùå No hay sesi√≥n despu√©s del callback');
          window.location.href = '/login?error=No se pudo obtener la sesi√≥n';
        }
      } catch (error: any) {
        console.error('‚ùå Error en callback:', error);
        window.location.href = `/login?error=${encodeURIComponent(error.message || 'Error en autenticaci√≥n')}`;
      }
    }

    // Verificar el hash de la URL para OAuth antes de inicializar
    function checkForHashError() {
      if (window.location.hash) {
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        const error = hashParams.get('error');
        
        if (error) {
          console.error('‚ùå Error en hash:', error);
          window.location.href = `/login?error=${encodeURIComponent(error)}`;
          return true; // Indica que hay un error
        }
      }
      return false; // No hay error
    }

    // Inicializar Supabase cuando est√© listo
    function startCallback() {
      // Verificar errores en el hash primero
      if (checkForHashError()) {
        return; // Si hay error, no continuar
      }
      
      // Inicializar Supabase
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          setTimeout(initSupabase, 100);
        });
      } else {
        setTimeout(initSupabase, 100);
      }
    }

    // Iniciar el proceso
    startCallback();
  </script>
</BaseLayout>
