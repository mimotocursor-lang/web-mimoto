---
// Datos de reviews de Google
const reviews = [
  {
    name: "Horacio Larrain",
    rating: 5,
    date: "Hace 3 semanas",
    text: "Fueron recomendados por varios contactos m√≠os. Llegu√© con una 1050 por un problema de v√°lvulas y luego volv√≠ para servicios de transmisi√≥n. Excelente servicio y mec√°nicos de primer nivel.",
    isLocalGuide: false,
    reviewCount: 10
  },
  {
    name: "ricardo mukarker",
    rating: 5,
    date: "Hace 3 semanas",
    text: "Un excelente servicio y mec√°nicos de primer nivel muy buen servicio. fui por un problema de frenos y me solucionaron el problema muy r√°pido lo recomiendo",
    isLocalGuide: true,
    reviewCount: 23
  },
  {
    name: "Ignacio Fuentes Padilla",
    rating: 5,
    date: "Hace 8 meses",
    text: "Excelente experiencia con don claudio y don hugo, me vieron mi 1190, me explicaron detalles de la moto, siempre don claudio con las ganas de explicar y educar y lo mejor de todo un servicio impecable.",
    isLocalGuide: false,
    reviewCount: 3
  },
  {
    name: "mekniqo",
    rating: 5,
    date: "Hace 7 meses",
    text: "Excelente servicio t√©cnico KTM, fui muy bien atendido por sus propios due√±os, se hizo una mantenci√≥n x kilometraje de mi 990 adventure y se solucion√≥ un problema de mezcla excesivamente rica, ahora se nota el cambio en la suavidad.",
    isLocalGuide: false,
    reviewCount: 3
  },
  {
    name: "David Fandi√±o",
    rating: 5,
    date: "Hace 3 a√±os",
    text: "Definitivamente el mejor servicio al cliente que he recibido por parte de un taller de motos en Santiago. Hugo (la persona que me atendi√≥) y Benjam√≠n (el mec√°nico) me dieron un excelente trato. Mi moto estuvo lista en tan solo un par de d√≠as.",
    isLocalGuide: false,
    reviewCount: 2
  },
  {
    name: "Luis Rueda",
    rating: 5,
    date: "Hace 2 a√±os",
    text: "Excelente servicio. serios y responsables. Buenos consejos de conducci√≥n.",
    isLocalGuide: true,
    reviewCount: 83
  },
  {
    name: "Vicente Villalon",
    rating: 5,
    date: "Hace un a√±o",
    text: "Taller muy profesional y ordenado. Dejaron mi moto en perfectas condiciones. Adicionalmente la atenci√≥n es de primer nivel. Muy cordiales y preocupados",
    isLocalGuide: false,
    reviewCount: 5
  },
  {
    name: "mariano forti",
    rating: 5,
    date: "Hace un a√±o",
    text: "Exelente todo, vinimos de apuro a cambiar la cadena de la moto, nos atendieron r√°pido y de 10. Es un taller chico, pero con gente que sabe",
    isLocalGuide: true,
    reviewCount: 51
  },
  {
    name: "fernando sandoval",
    rating: 5,
    date: "Hace un a√±o",
    text: "Gran servicio, excelente post venta. A√±os llevando mis motos y siempre recomendados. Adem√°s de ser autorizados KTM, les he llevado otras marcas y siempre con el mismo nivel de excelencia.",
    isLocalGuide: true,
    reviewCount: 59
  }
];

function getStars(rating: number) {
  return '‚≠ê'.repeat(rating);
}

function truncateText(text: string, maxLength: number = 150) {
  if (text.length <= maxLength) return text;
  return text.substring(0, maxLength).trim() + '...';
}
---

<div class="google-reviews-carousel-container">
  <div class="google-reviews-carousel">
    {reviews.map((review, index) => (
      <div 
        class={`google-review-card ${index === 0 ? 'active' : ''}`}
        data-review-index={index}
      >
        <div class="google-review-header">
          <div class="google-review-author">
            <div class="google-review-avatar">
              {review.name.charAt(0).toUpperCase()}
            </div>
            <div class="google-review-author-info">
              <div class="google-review-name">
                {review.name}
                {review.isLocalGuide && (
                  <span class="google-local-guide-badge" title="Local Guide">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                  </span>
                )}
              </div>
              <div class="google-review-meta">
                <span class="google-review-rating">{getStars(review.rating)}</span>
                {review.reviewCount > 0 && (
                  <span class="google-review-count">{review.reviewCount} opiniones</span>
                )}
              </div>
            </div>
          </div>
          <div class="google-review-date">{review.date}</div>
        </div>
        <div class="google-review-text">
          {truncateText(review.text)}
        </div>
        <div class="google-review-footer">
          <a 
            href="https://www.google.com/maps/place/Mimoto/@-33.416667,-70.583333?entry=ttu"
            target="_blank"
            rel="noopener noreferrer"
            class="google-review-link"
          >
            Ver en Google ‚Üí
          </a>
        </div>
      </div>
    ))}
  </div>
  
  <!-- Indicadores -->
  <div class="google-reviews-indicators">
    {reviews.map((_, index) => (
      <button
        class={`google-review-indicator ${index === 0 ? 'active' : ''}`}
        data-review-index={index}
        aria-label={`Review ${index + 1}`}
      ></button>
    ))}
  </div>
  
  <!-- Bot√≥n para dejar review -->
  <div class="google-review-cta">
    <a 
      href="https://www.google.com/maps/place/Mimoto/@-33.416667,-70.583333?entry=ttu"
      target="_blank"
      rel="noopener noreferrer"
      class="google-review-button"
    >
      Deja tu opini√≥n en Google
    </a>
  </div>
</div>

<style>
  .google-reviews-carousel-container {
    position: relative;
    width: 100%;
    max-width: 400px;
    margin: 0 auto;
  }

  .google-reviews-carousel {
    position: relative;
    min-height: 280px;
    width: 100%;
    overflow: visible;
  }

  .google-review-card {
    display: none;
    width: 100%;
    /* Light mode */
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(0, 0, 0, 0.15);
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    opacity: 0;
    transform: translateX(20px);
    transition: opacity 0.6s ease-in-out, transform 0.6s ease-in-out;
  }
  
  /* La primera card con clase active debe ser visible desde el inicio */
  .google-review-card.active {
    display: block !important;
    opacity: 1 !important;
    transform: translateX(0) !important;
  }

  /* Dark mode - m√°s opaco para mejor contraste */
  .dark .google-review-card {
    background: rgba(30, 41, 59, 0.98);
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.6);
  }

  .google-review-card.active {
    display: block !important;
    opacity: 1 !important;
    transform: translateX(0) !important;
  }

  .google-review-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
    gap: 12px;
  }

  .google-review-author {
    display: flex;
    gap: 12px;
    flex: 1;
  }

  .google-review-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #ff6600 0%, #ff8533 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 18px;
    flex-shrink: 0;
  }

  .google-review-author-info {
    flex: 1;
    min-width: 0;
  }

  .google-review-name {
    font-weight: bold;
    /* Light mode */
    color: #1a1a1a;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 4px;
  }

  /* Dark mode - texto m√°s claro para contraste */
  .dark .google-review-name {
    color: #ffffff;
  }

  .google-local-guide-badge {
    display: inline-flex;
    align-items: center;
    color: #4285F4;
    flex-shrink: 0;
  }

  .google-review-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }

  .google-review-rating {
    font-size: 12px;
    line-height: 1;
  }

  .google-review-count {
    font-size: 11px;
    /* Light mode */
    color: rgba(0, 0, 0, 0.6);
  }

  /* Dark mode */
  .dark .google-review-count {
    color: rgba(255, 255, 255, 0.7);
  }

  .google-review-date {
    font-size: 11px;
    /* Light mode */
    color: rgba(0, 0, 0, 0.6);
    white-space: nowrap;
    flex-shrink: 0;
  }

  /* Dark mode */
  .dark .google-review-date {
    color: rgba(255, 255, 255, 0.7);
  }

  .google-review-text {
    /* Light mode */
    color: rgba(0, 0, 0, 0.85);
    font-size: 13px;
    line-height: 1.6;
    margin-bottom: 12px;
  }

  /* Dark mode - texto m√°s claro */
  .dark .google-review-text {
    color: rgba(255, 255, 255, 0.95);
  }

  .google-review-footer {
    /* Light mode */
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    padding-top: 12px;
  }

  /* Dark mode */
  .dark .google-review-footer {
    border-top: 1px solid rgba(255, 255, 255, 0.15);
  }

  .google-review-link {
    color: #4285F4;
    font-size: 12px;
    text-decoration: none;
    font-weight: 500;
    transition: color 0.2s;
  }

  .google-review-link:hover {
    color: #5a9df4;
    text-decoration: underline;
  }

  .google-reviews-indicators {
    display: flex;
    justify-content: center;
    gap: 6px;
    margin-top: 12px;
    margin-bottom: 8px;
  }

  .google-review-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    border: none;
    /* Light mode */
    background: rgba(0, 0, 0, 0.2);
    cursor: pointer;
    transition: background 0.3s, transform 0.3s;
    padding: 0;
  }

  /* Dark mode */
  .dark .google-review-indicator {
    background: rgba(255, 255, 255, 0.3);
  }

  .google-review-indicator:hover {
    /* Light mode */
    background: rgba(0, 0, 0, 0.4);
    transform: scale(1.2);
  }

  /* Dark mode */
  .dark .google-review-indicator:hover {
    background: rgba(255, 255, 255, 0.5);
  }

  .google-review-indicator.active {
    background: #ff6600;
    transform: scale(1.3);
  }

  .google-review-cta {
    text-align: center;
    margin-top: 8px;
  }

  .google-review-button {
    display: inline-block;
    padding: 10px 20px;
    /* Light mode - m√°s visible */
    background: rgba(255, 102, 0, 0.9);
    border: 1px solid rgba(255, 102, 0, 1);
    border-radius: 8px;
    color: #ffffff;
    text-decoration: none;
    font-size: 12px;
    font-weight: 700;
    transition: all 0.3s;
  }

  /* Dark mode - bot√≥n m√°s visible */
  .dark .google-review-button {
    background: rgba(255, 102, 0, 0.8);
    border: 1px solid rgba(255, 102, 0, 1);
    color: #ffffff;
    font-weight: 700;
  }

  .google-review-button:hover {
    /* Light mode */
    background: rgba(255, 102, 0, 1);
    border-color: rgba(255, 102, 0, 1);
    box-shadow: 0 4px 12px rgba(255, 102, 0, 0.4);
    transform: translateY(-2px);
  }

  /* Dark mode */
  .dark .google-review-button:hover {
    background: rgba(255, 102, 0, 1);
    border-color: rgba(255, 102, 0, 1);
    box-shadow: 0 4px 12px rgba(255, 102, 0, 0.4);
  }

  /* Responsive - reducir espacios en m√≥viles */
  @media (max-width: 768px) {
    .google-reviews-carousel-container {
      max-width: 100%;
      width: 100%;
      display: block;
      visibility: visible;
    }

    .google-reviews-carousel {
      min-height: 280px;
      width: 100%;
      display: block;
      position: relative;
      overflow: visible;
    }

    .google-review-card {
      padding: 14px;
    }
    
    /* En responsive, las cards inactivas deben estar ocultas */
    .google-review-card:not(.active) {
      display: none !important;
    }
    
    .google-review-card.active {
      display: block !important;
      opacity: 1 !important;
      transform: translateX(0) !important;
    }

    .google-review-header {
      margin-bottom: 8px;
    }

    .google-review-text {
      margin-bottom: 8px;
      font-size: 12px;
      line-height: 1.5;
    }

    .google-review-footer {
      padding-top: 8px;
    }

    .google-review-avatar {
      width: 32px;
      height: 32px;
      font-size: 14px;
    }

    .google-review-name {
      font-size: 13px;
    }

    .google-reviews-indicators {
      margin-top: 8px;
      margin-bottom: 4px;
      display: flex;
      visibility: visible;
      opacity: 1;
    }

    .google-review-cta {
      margin-top: 4px;
      display: block;
      visibility: visible;
      opacity: 1;
    }

    .google-review-button {
      padding: 8px 16px;
      font-size: 11px;
    }
  }
</style>

<script>
  // Esperar a que el DOM est√© completamente cargado
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCarousel);
  } else {
    // DOM ya est√° listo
    setTimeout(initCarousel, 100);
  }
  
  function initCarousel() {
    const cards = document.querySelectorAll('.google-review-card');
    const indicators = document.querySelectorAll('.google-review-indicator');
    
    // Asegurar que siempre haya al menos una card visible
    if (cards.length === 0) return;
    
    // Si solo hay una card, asegurarse de que est√© visible
    if (cards.length === 1) {
      const singleCard = cards[0] as HTMLElement;
      singleCard.classList.add('active');
      singleCard.style.position = 'relative';
      singleCard.style.visibility = 'visible';
      singleCard.style.opacity = '1';
      if (indicators.length > 0) {
        indicators[0].classList.add('active');
      }
      return;
    }
    
    let currentIndex = 0;
    let intervalId: ReturnType<typeof setInterval> | null = null;
    
    // Funci√≥n segura para mostrar review con manejo de errores
    const safeShowReview = (index: number) => {
      try {
        // Asegurar que el √≠ndice est√© en rango v√°lido usando m√≥dulo
        // Manejar √≠ndices negativos y mayores al array
        let validIndex = index;
        if (validIndex < 0) {
          validIndex = cards.length - 1; // Si es negativo, ir al √∫ltimo
        } else if (validIndex >= cards.length) {
          validIndex = 0; // Si es mayor, volver al primero
        } else {
          validIndex = validIndex % cards.length; // M√≥dulo para loop
        }
        
        // Asegurar que validIndex est√© en rango v√°lido
        validIndex = Math.max(0, Math.min(validIndex, cards.length - 1));
        
        console.log(`üîÑ Mostrando review ${validIndex + 1} de ${cards.length} (√≠ndice recibido: ${index}, √≠ndice v√°lido: ${validIndex})`);
        
        // Primero activar la nueva card ANTES de desactivar la anterior
        // Esto evita que quede vac√≠o moment√°neamente
        if (cards[validIndex]) {
          const newCard = cards[validIndex] as HTMLElement;
          newCard.classList.add('active');
          // Forzar visibilidad
          newCard.style.display = 'block';
          newCard.style.opacity = '1';
          newCard.style.visibility = 'visible';
        }
        
        // Luego ocultar las dem√°s cards
        cards.forEach((card, i) => {
          if (i !== validIndex) {
            const inactiveCard = card as HTMLElement;
            inactiveCard.classList.remove('active');
            inactiveCard.style.display = 'none';
          }
        });
        
        // Actualizar indicadores
        indicators.forEach((indicator, i) => {
          if (i === validIndex) {
            indicator.classList.add('active');
          } else {
            indicator.classList.remove('active');
          }
        });
        
        currentIndex = validIndex;
        
        // Verificar que la card activa sea visible
        const activeCard = cards[validIndex] as HTMLElement;
        if (activeCard) {
          if (!activeCard.classList.contains('active')) {
            console.warn('‚ö†Ô∏è La card no tiene la clase active, corrigiendo...');
            activeCard.classList.add('active');
          }
          // Asegurar visibilidad
          activeCard.style.display = 'block';
          activeCard.style.opacity = '1';
          activeCard.style.visibility = 'visible';
        }
      } catch (error) {
        console.error('‚ùå Error en showReview:', error);
        // Fallback: activar la primera card
        if (cards.length > 0) {
          const firstCard = cards[0] as HTMLElement;
          firstCard.classList.add('active');
          firstCard.style.display = 'block';
          firstCard.style.opacity = '1';
          firstCard.style.visibility = 'visible';
          
          cards.forEach((card, i) => {
            if (i !== 0) {
              const inactiveCard = card as HTMLElement;
              inactiveCard.classList.remove('active');
              inactiveCard.style.display = 'none';
            }
          });
          
          if (indicators.length > 0) {
            indicators[0].classList.add('active');
            indicators.forEach((indicator, i) => {
              if (i !== 0) {
                indicator.classList.remove('active');
              }
            });
          }
          currentIndex = 0;
        }
      }
    };
    
    // Asegurar que la primera card est√© activa desde el inicio
    const initialActiveCard = document.querySelector('.google-review-card.active');
    if (initialActiveCard) {
      // Encontrar el √≠ndice de la card activa
      cards.forEach((card, i) => {
        if (card === initialActiveCard) {
          currentIndex = i;
        }
      });
      // Asegurar que la card activa sea visible
      safeShowReview(currentIndex);
    } else {
      // Si no hay ninguna activa, activar la primera
      if (cards.length > 0) {
        currentIndex = 0;
        safeShowReview(0);
      }
    }
    
    console.log(`‚úÖ Carrusel inicializado con ${cards.length} reviews. √çndice inicial: ${currentIndex}`);
    
    // Cambiar review cada 5 segundos - loop infinito
    intervalId = setInterval(() => {
      // Incrementar √≠ndice y usar m√≥dulo para loop infinito
      // Esto garantiza que cuando llegue a cards.length, vuelva a 0 autom√°ticamente
      currentIndex = (currentIndex + 1) % cards.length;
      
      console.log(`‚è≠Ô∏è Siguiente review: ${currentIndex + 1} de ${cards.length} (√≠ndice: ${currentIndex})`);
      
      // Mostrar el review
      safeShowReview(currentIndex);
    }, 5000);
    
    // Permitir click en indicadores
    indicators.forEach((indicator, index) => {
      indicator.addEventListener('click', () => {
        // Validar √≠ndice antes de asignar
        const validIndex = Math.max(0, Math.min(index, cards.length - 1));
        currentIndex = validIndex;
        safeShowReview(currentIndex);
        // Reiniciar el intervalo despu√©s de un click manual
        if (intervalId) {
          clearInterval(intervalId);
        }
        intervalId = setInterval(() => {
          currentIndex = currentIndex + 1;
          
          // Si llegamos al final del array, volver a 0 (loop infinito)
          if (currentIndex >= cards.length) {
            currentIndex = 0;
          }
          
          const nextIndex = currentIndex % cards.length;
          safeShowReview(nextIndex);
          currentIndex = nextIndex;
        }, 5000);
      });
    });
    
    // Asegurar que siempre haya una card visible (fallback m√∫ltiple)
    const ensureActiveCard = () => {
      const activeCard = document.querySelector('.google-review-card.active');
      if (!activeCard && cards.length > 0) {
        console.warn('‚ö†Ô∏è No hay card activa, activando la primera...');
        currentIndex = 0;
        safeShowReview(0);
      }
    };
    
    // Verificar inmediatamente
    ensureActiveCard();
    
    // Verificar despu√©s de un breve delay
    setTimeout(ensureActiveCard, 100);
    
    // Verificar despu√©s de que el DOM est√© completamente cargado
    setTimeout(ensureActiveCard, 500);
    
    // Verificar peri√≥dicamente que siempre haya una card visible
    setInterval(() => {
      const activeCard = document.querySelector('.google-review-card.active');
      if (!activeCard && cards.length > 0) {
        console.warn('‚ö†Ô∏è Verificaci√≥n peri√≥dica: No hay card activa, activando la primera...');
        currentIndex = 0;
        safeShowReview(0);
      }
    }, 2000); // Verificar cada 2 segundos
    
    // Verificar despu√©s de 1 segundo para asegurar que todo est√© estable
    setTimeout(() => {
      const activeCard = document.querySelector('.google-review-card.active');
      if (activeCard) {
        const cardEl = activeCard as HTMLElement;
        cardEl.style.position = 'relative';
        cardEl.style.visibility = 'visible';
        cardEl.style.opacity = '1';
        cardEl.style.zIndex = '10';
        cardEl.style.display = 'block';
      } else {
        console.warn('‚ö†Ô∏è Despu√©s de 1 segundo: No hay card activa, activando la primera...');
        currentIndex = 0;
        safeShowReview(0);
      }
    }, 1000);
    
    // Verificar peri√≥dicamente para asegurar que siempre haya una card visible
    const checkInterval = setInterval(() => {
      const activeCard = document.querySelector('.google-review-card.active');
      if (!activeCard && cards.length > 0) {
        console.log('‚ö†Ô∏è No hay card activa detectada, reactivando...');
        safeShowReview(currentIndex);
      }
      // Verificar tambi√©n que la card activa sea visible
      if (activeCard) {
        const computedStyle = window.getComputedStyle(activeCard);
        if (computedStyle.visibility === 'hidden' || computedStyle.opacity === '0') {
          console.log('‚ö†Ô∏è Card activa no es visible, corrigiendo...');
          activeCard.classList.remove('active');
          safeShowReview(currentIndex);
        }
      }
    }, 1000);
  }
</script>

