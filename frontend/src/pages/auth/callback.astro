---
import BaseLayout from '../../layouts/BaseLayout.astro';
---

<BaseLayout title="Autenticando... - Mimoto">
  <section class="max-w-md mx-auto px-4 py-16 text-center">
    <div class="bg-white border-2 border-primary rounded-xl p-8 shadow-lg">
      <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-primary/10 mb-4">
        <svg class="w-8 h-8 text-primary animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
      </div>
      <p class="text-gray-700 font-semibold">Procesando autenticaci√≥n...</p>
    </div>
  </section>

  <script>
    import { supabaseClient } from '../../../lib/supabase/client';

    async function handleAuthCallback() {
      const hashParams = new URLSearchParams(window.location.hash.substring(1));
      const accessToken = hashParams.get('access_token');
      const error = hashParams.get('error');

      if (error) {
        window.location.href = `/login?error=${encodeURIComponent(error)}`;
        return;
      }

      if (accessToken) {
        const { data, error: sessionError } = await supabaseClient.auth.getSession();

        if (sessionError) {
          window.location.href = `/login?error=${encodeURIComponent(sessionError.message)}`;
          return;
        }

        if (data.session?.user) {
          const { data: existingUser } = await supabaseClient
            .from('users')
            .select('id')
            .eq('id', data.session.user.id)
            .single();

          if (!existingUser) {
            await supabaseClient.from('users').insert({
              id: data.session.user.id,
              email: data.session.user.email,
              full_name: data.session.user.user_metadata?.full_name || data.session.user.user_metadata?.name || '',
              role: 'buyer',
            });
          }
        }

        const returnUrl = new URLSearchParams(window.location.search).get('return') || '/';
        window.location.href = returnUrl;
      } else {
        window.location.href = '/login';
      }
    }

    handleAuthCallback();
  </script>
</BaseLayout>
