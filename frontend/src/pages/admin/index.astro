---
import BaseLayout from '../../layouts/BaseLayout.astro';
---

<BaseLayout title="Dashboard Admin - Mimoto">
  <section class="max-w-6xl mx-auto px-4 py-16">
    <div class="flex items-center justify-between mb-8">
      <h1 class="text-3xl font-bold text-ktm-light-text dark:text-ktm-text">Dashboard Admin</h1>
      <nav class="flex gap-4 text-sm">
        <a href="/admin" class="text-ktm-accent dark:text-ktm-accent font-bold">Dashboard</a>
        <a href="/admin/ordenes" class="text-ktm-light-text/80 dark:text-ktm-text/80 hover:text-ktm-accent font-semibold">√ìrdenes</a>
        <a href="/admin/productos" class="text-ktm-light-text/80 dark:text-ktm-text/80 hover:text-ktm-accent font-semibold">Productos</a>
        <a href="/admin/motos-usadas" class="text-ktm-light-text/80 dark:text-ktm-text/80 hover:text-ktm-accent font-semibold">Motos Usadas</a>
        <a href="/admin/banners" class="text-ktm-light-text/80 dark:text-ktm-text/80 hover:text-ktm-accent font-semibold">Banners</a>
      </nav>
    </div>

    <div id="admin-content" class="space-y-6">
      <div class="grid sm:grid-cols-2 lg:grid-cols-5 gap-4">
        <div class="border-2 border-ktm-accent dark:border-primary rounded-xl p-6 bg-white dark:bg-ktm-surface/50 shadow-lg">
          <p class="text-xs text-gray-600 dark:text-ktm-text/70 mb-1 font-semibold uppercase">Total Ventas</p>
          <p id="kpi-sales" class="text-3xl font-bold text-ktm-accent">$0</p>
        </div>
        <div class="border-2 border-gray-200 dark:border-primary/30 rounded-xl p-6 bg-white dark:bg-ktm-surface/50 shadow-lg">
          <p class="text-xs text-gray-600 dark:text-ktm-text/70 mb-1 font-semibold uppercase">Productos Activos</p>
          <p id="kpi-products-active" class="text-3xl font-bold text-gray-900 dark:text-ktm-text">0</p>
        </div>
        <div class="border-2 border-gray-200 dark:border-primary/30 rounded-xl p-6 bg-white dark:bg-ktm-surface/50 shadow-lg">
          <p class="text-xs text-gray-600 dark:text-ktm-text/70 mb-1 font-semibold uppercase">Motos Activas</p>
          <p id="kpi-motos-active" class="text-3xl font-bold text-gray-900 dark:text-ktm-text">0</p>
        </div>
        <div class="border-2 border-gray-200 dark:border-primary/30 rounded-xl p-6 bg-white dark:bg-ktm-surface/50 shadow-lg">
          <p class="text-xs text-gray-600 dark:text-ktm-text/70 mb-1 font-semibold uppercase">√ìrdenes Totales</p>
          <p id="kpi-orders" class="text-3xl font-bold text-gray-900 dark:text-ktm-text">0</p>
        </div>
        <div class="border-2 border-red-400 dark:border-red-500 rounded-xl p-6 bg-white dark:bg-ktm-surface/50 shadow-lg">
          <p class="text-xs text-gray-600 dark:text-ktm-text/70 mb-1 font-semibold uppercase">Stock Bajo</p>
          <p id="kpi-low-stock" class="text-3xl font-bold text-red-500 dark:text-red-400">0</p>
        </div>
      </div>

      <div class="border-2 border-gray-200 dark:border-primary/30 rounded-xl p-6 bg-white dark:bg-ktm-surface/50 shadow-lg">
        <h2 class="font-bold text-xl mb-4 text-gray-900 dark:text-ktm-text">Productos con stock bajo</h2>
        <div id="low-stock-products" class="text-sm text-gray-700 dark:text-ktm-text/80">
          <p class="text-gray-600 dark:text-ktm-text/70">Cargando...</p>
        </div>
      </div>
    </div>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Valores hardcodeados como fallback
    const SUPABASE_URL = 'https://prizpqahcluomioxnmex.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InByaXpwcWFoY2x1b21pb3hubWV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3OTIxNjIsImV4cCI6MjA3MzM2ODE2Mn0.7qJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJq';
    
    let supabaseClient = null;
    let supabaseLoadAttempts = 0;
    const MAX_ATTEMPTS = 50;
    
    function initAdmin() {
      if (typeof supabase === 'undefined') {
        supabaseLoadAttempts++;
        if (supabaseLoadAttempts > MAX_ATTEMPTS) {
          console.error('‚ùå Timeout: Supabase no se carg√≥');
          alert('Error: No se pudo cargar Supabase. Por favor, recarga la p√°gina.');
          return;
        }
        setTimeout(initAdmin, 100);
        return;
      }
      
      const supabaseUrl = (typeof window !== 'undefined' && window.PUBLIC_SUPABASE_URL) || SUPABASE_URL;
      const supabaseAnonKey = (typeof window !== 'undefined' && window.PUBLIC_SUPABASE_ANON_KEY) || SUPABASE_KEY;
      
      supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey, {
        auth: {
          persistSession: true,
          autoRefreshToken: true,
          detectSessionInUrl: true
        }
      });
      
      console.log('‚úÖ Admin: Cliente de Supabase inicializado');
      
      // Verificar acceso inmediatamente
      checkAdminAccess().then(function(hasAccess) {
        if (!hasAccess) {
          const adminContent = document.getElementById('admin-content');
          if (adminContent) {
            adminContent.innerHTML = '<p class="text-center py-12">Verificando acceso...</p>';
          }
        } else {
          loadDashboardData();
        }
      });
    }

    async function checkAdminAccess() {
      if (!supabaseClient) {
        console.error('‚ùå Admin: Cliente de Supabase no inicializado');
        window.location.href = '/login?return=/admin';
        return false;
      }
      
      try {
        const sessionResult = await supabaseClient.auth.getSession();
        const session = sessionResult.data ? sessionResult.data.session : null;
        
        console.log('üîç Admin: Verificando sesi√≥n...', session ? 'Sesi√≥n encontrada' : 'Sin sesi√≥n');
        
        if (!session) {
          console.log('‚ùå Admin: No hay sesi√≥n, redirigiendo a login');
          window.location.href = '/login?return=/admin';
          return false;
        }

        console.log('üîç Admin: Verificando rol de usuario...');
        const profileResult = await supabaseClient
          .from('users')
          .select('role')
          .eq('id', session.user.id)
          .single();

        const profile = profileResult.data;
        console.log('üîç Admin: Perfil obtenido:', profile ? 'Perfil encontrado' : 'Sin perfil');
        console.log('üîç Admin: Rol:', profile ? profile.role : 'N/A');

        if (!profile || profile.role !== 'admin') {
          console.log('‚ùå Admin: Usuario no es admin, redirigiendo');
          alert('No tienes permisos para acceder a esta p√°gina');
          window.location.href = '/';
          return false;
        }

        console.log('‚úÖ Admin: Acceso autorizado');
        return true;
      } catch (error) {
        console.error('‚ùå Admin: Error verificando acceso:', error);
        window.location.href = '/login?return=/admin';
        return false;
      }
    }

    async function loadDashboardData() {
      const hasAccess = await checkAdminAccess();
      if (!hasAccess) {
        console.log('‚ùå Admin: Sin acceso, no cargando datos');
        return;
      }

      try {
        console.log('üìä Admin: Cargando datos del dashboard...');
        
        // Cargar KPIs desde Supabase
        const [ordersRes, productsRes, motosRes] = await Promise.all([
          supabaseClient.from('orders').select('total_amount, status'),
          supabaseClient.from('products').select('id, name, status, stock'),
          supabaseClient.from('used_motorcycles').select('id, status'),
        ]);

        // Calcular total de ventas (√≥rdenes pagadas y en proceso)
        // Incluir: paid, order_received, order_confirmed, order_delivered
        const paidStatuses = ['paid', 'order_received', 'order_confirmed', 'order_delivered'];
        const totalSales = ordersRes.data
          ?.filter(function(o) { return paidStatuses.includes(o.status); })
          .reduce(function(sum, o) { return sum + Number(o.total_amount || 0); }, 0) || 0;
        
        console.log('üí∞ Ventas calculadas:', {
          totalOrders: ordersRes.data?.length || 0,
          paidOrders: ordersRes.data?.filter(function(o) { return paidStatuses.includes(o.status); }).length || 0,
          totalSales: totalSales
        });

        // Contar productos activos
        const productsActive = productsRes.data ? productsRes.data.filter(function(p) { return p.status === 'active'; }).length : 0;

        // Contar motos activas
        const motosActive = motosRes.data ? motosRes.data.filter(function(m) { return m.status === 'active'; }).length : 0;

        // Total de √≥rdenes
        const totalOrders = ordersRes.data ? ordersRes.data.length : 0;

        // Productos con stock bajo
        const lowStock = productsRes.data ? productsRes.data.filter(function(p) { return p.stock <= 5 && p.status === 'active'; }) : [];

        // Actualizar UI
        const kpiSales = document.getElementById('kpi-sales');
        const kpiProducts = document.getElementById('kpi-products-active');
        const kpiMotos = document.getElementById('kpi-motos-active');
        const kpiOrders = document.getElementById('kpi-orders');
        const kpiLowStock = document.getElementById('kpi-low-stock');
        
        if (kpiSales) kpiSales.textContent = '$' + totalSales.toLocaleString('es-CL');
        if (kpiProducts) kpiProducts.textContent = productsActive.toString();
        if (kpiMotos) kpiMotos.textContent = motosActive.toString();
        if (kpiOrders) kpiOrders.textContent = totalOrders.toString();
        if (kpiLowStock) kpiLowStock.textContent = lowStock.length.toString();

        const lowStockEl = document.getElementById('low-stock-products');
        if (lowStockEl) {
          if (lowStock.length === 0) {
            lowStockEl.innerHTML = '<p class="text-gray-600 dark:text-ktm-text/70">No hay productos con stock bajo</p>';
          } else {
            lowStockEl.innerHTML = lowStock
              .map(function(p) {
                return '<div class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-primary/30 last:border-0">' +
                  '<span class="text-gray-900 dark:text-ktm-text font-medium">' + (p.name || 'Sin nombre') + '</span>' +
                  '<span class="text-red-500 dark:text-red-400 font-bold">Stock: ' + p.stock + '</span>' +
                  '</div>';
              })
              .join('');
          }
        }
        
        console.log('‚úÖ Admin: Datos del dashboard cargados');
      } catch (err) {
        console.error('‚ùå Admin: Error cargando dashboard:', err);
      }
    }

    // Inicializar cuando Supabase est√© listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        setTimeout(initAdmin, 100);
      });
    } else {
      setTimeout(initAdmin, 100);
    }
  </script>
</BaseLayout>

