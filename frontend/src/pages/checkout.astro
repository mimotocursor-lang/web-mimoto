---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="Checkout - Mimoto">
  <section class="max-w-6xl mx-auto px-4 py-12 md:py-16 space-y-8">
    <div class="text-center mb-8">
      <h1 class="text-4xl md:text-5xl font-bold text-white mb-2">Checkout</h1>
      <p class="text-white/80">Revisa tu pedido antes de confirmar</p>
    </div>
    
    <div class="grid gap-8 md:grid-cols-[2fr,1.5fr]">
      <!-- Datos del comprador -->
      <div class="space-y-6 bg-gray-900/50 border-2 border-primary rounded-xl p-6 shadow-lg backdrop-blur-sm">
        <h2 class="text-2xl font-bold text-white border-b-2 border-primary pb-2">Datos del comprador</h2>
        <p class="text-sm text-white/70">
          Aqu√≠ se mostrar√°n los datos del usuario autenticado desde Supabase. Si no est√°s
          logueado, ser√°s redirigido a la p√°gina de login.
        </p>
        <div id="checkout-user" class="text-sm text-white/90 bg-gray-800/50 p-4 rounded-lg border border-primary/30"></div>
      </div>
      
      <!-- Resumen del pedido -->
      <aside class="bg-gray-900/50 border-2 border-primary rounded-xl p-6 shadow-lg space-y-4 backdrop-blur-sm">
        <h2 class="text-xl font-bold text-white border-b-2 border-primary pb-2">Resumen del pedido</h2>
        <div id="checkout-items" class="space-y-3 text-sm"></div>
        <div class="border-t-2 border-primary pt-4 flex justify-between items-center">
          <span class="text-lg font-bold text-white">Total</span>
          <span id="checkout-total" class="text-2xl font-bold text-primary">$0</span>
        </div>
        <button
          id="confirm-order-btn"
          type="button"
          class="w-full mt-4 inline-flex items-center justify-center px-6 py-4 rounded-lg bg-primary text-white font-bold hover:bg-primary-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg text-lg hover:scale-105"
        >
          Confirmar compra
        </button>
        <p id="checkout-error" class="text-xs text-red-400 text-center"></p>
      </aside>
    </div>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const STORAGE_KEY = 'mimoto_cart_v1';

    function loadCart() {
      try {
        const rawData = localStorage.getItem(STORAGE_KEY);
        console.log('üõí Checkout: Datos en localStorage:', rawData ? 'Encontrado' : 'No encontrado');
        if (!rawData) {
          return [];
        }
        const raw = JSON.parse(rawData);
        console.log('üõí Checkout: Datos parseados:', typeof raw);
        
        if (Array.isArray(raw)) {
          console.log('‚úÖ Carrito es array con', raw.length, 'items');
          return raw;
        }
        if (raw && typeof raw === 'object' && Array.isArray(raw.items)) {
          console.log('‚úÖ Carrito tiene items con', raw.items.length, 'items');
          return raw.items;
        }
        console.warn('‚ö†Ô∏è Formato inesperado del carrito');
        return [];
      } catch (error) {
        console.error('‚ùå Error parseando carrito:', error);
        return [];
      }
    }

    function renderSummary(cart) {
      const itemsEl = document.getElementById('checkout-items');
      const totalEl = document.getElementById('checkout-total');
      if (!itemsEl || !totalEl) {
        console.error('‚ùå Elementos del DOM no encontrados');
        return;
      }

      if (cart.length === 0) {
        itemsEl.innerHTML = '<p class="text-white/70 text-center py-4">Tu carrito est√° vac√≠o. Agrega productos desde la tienda.</p>';
        totalEl.textContent = '$0';
        return;
      }

      let total = 0;
      itemsEl.innerHTML = cart
        .map(function(item) {
          const price = Number(item.price) || 0;
          const quantity = Number(item.quantity) || 1;
          const lineTotal = price * quantity;
          total += lineTotal;
          return '<div class="flex justify-between items-center p-3 bg-gray-800/50 rounded-lg border border-primary/30">' +
            '<div>' +
            '<span class="font-semibold text-white">' + (item.name || 'Producto') + '</span>' +
            '<span class="text-white/70 text-xs block">Cantidad: ' + quantity + '</span>' +
            '</div>' +
            '<span class="font-bold text-primary text-lg">$' + lineTotal.toLocaleString('es-CL') + '</span>' +
            '</div>';
        })
        .join('');
      totalEl.textContent = '$' + total.toLocaleString('es-CL');
    }

    document.addEventListener('DOMContentLoaded', function() {
      console.log('üõí Checkout: Iniciando...');
      const cart = loadCart();
      console.log('üõí Checkout: Carrito cargado:', cart.length, 'items');
      
      renderSummary(cart);

      const confirmBtn = document.getElementById('confirm-order-btn');
      const errorEl = document.getElementById('checkout-error');

      if (!confirmBtn) {
        console.error('‚ùå Bot√≥n de confirmar no encontrado');
        return;
      }

      if (cart.length === 0) {
        console.warn('‚ö†Ô∏è Carrito vac√≠o, deshabilitando bot√≥n');
        confirmBtn.disabled = true;
      } else {
        console.log('‚úÖ Carrito tiene items, bot√≥n habilitado');
        confirmBtn.disabled = false;
      }

      confirmBtn.addEventListener('click', async function() {
        const currentCart = loadCart();
        console.log('üõí Checkout: Confirmando con', currentCart.length, 'items');
        
        if (currentCart.length === 0) {
          if (errorEl) errorEl.textContent = 'Tu carrito est√° vac√≠o. Agrega productos desde la tienda.';
          return;
        }
        
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'Creando pedido...';
        if (errorEl) errorEl.textContent = '';

        try {
          // Validar que el carrito tenga items
          if (!currentCart || currentCart.length === 0) {
            throw new Error('El carrito est√° vac√≠o');
          }
          
          console.log('üõí Checkout: Carrito original:', JSON.stringify(currentCart, null, 2));
          
          const items = currentCart.map(function(item) {
            const mapped = {
              productId: Number(item.id) || 0,
              quantity: Number(item.quantity) || 1,
              priceSnapshot: Number(item.price) || 0,
            };
            console.log('üõí Checkout: Item mapeado:', JSON.stringify(mapped));
            return mapped;
          });

          console.log('üõí Checkout: Creando pedido con items:', items);
          console.log('üõí Checkout: Cantidad de items:', items.length);
          console.log('üõí Checkout: Items completo:', JSON.stringify(items, null, 2));

          // Validar que items no est√© vac√≠o
          if (!items || items.length === 0) {
            throw new Error('No hay items en el carrito para crear el pedido');
          }

          // Validar que cada item tenga los campos necesarios
          for (let i = 0; i < items.length; i++) {
            const item = items[i];
            if (!item.productId || item.productId === 0) {
              console.error('‚ùå Item inv√°lido en √≠ndice', i, ':', item);
              throw new Error('Uno o m√°s items del carrito no tienen un productId v√°lido');
            }
          }

          // Obtener token de sesi√≥n si existe (usando CDN de Supabase)
          let authToken = null;
          if (typeof supabase !== 'undefined') {
            try {
              const SUPABASE_URL = 'https://prizpqahcluomioxnmex.supabase.co';
              const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InByaXpwcWFoY2x1b21pb3hubWV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3OTIxNjIsImV4cCI6MjA3MzM2ODE2Mn0.7qJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJq';
              
              const supabaseUrl = (typeof window !== 'undefined' && window.PUBLIC_SUPABASE_URL) || SUPABASE_URL;
              const supabaseAnonKey = (typeof window !== 'undefined' && window.PUBLIC_SUPABASE_ANON_KEY) || SUPABASE_KEY;
              const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);
              
              const sessionResult = await supabaseClient.auth.getSession();
              if (sessionResult.data && sessionResult.data.session) {
                authToken = sessionResult.data.session.access_token;
              }
            } catch (supabaseError) {
              console.warn('‚ö†Ô∏è No se pudo obtener sesi√≥n de Supabase:', supabaseError);
            }
          }

          // Preparar el body
          const requestBody = { items: items };
          const bodyString = JSON.stringify(requestBody);
          
          console.log('üõí Checkout: Body a enviar:', bodyString);
          console.log('üõí Checkout: Body length:', bodyString.length);
          console.log('üõí Checkout: Items en body:', items.length);
          console.log('üõí Checkout: Items detalle:', JSON.stringify(items, null, 2));

          // Validar que el body no est√© vac√≠o
          if (!bodyString || bodyString === '{}' || bodyString === '{"items":[]}') {
            console.error('‚ùå Body vac√≠o o inv√°lido:', bodyString);
            throw new Error('El cuerpo de la petici√≥n est√° vac√≠o o no tiene items v√°lidos');
          }

          // Validar que bodyString sea un string v√°lido
          if (typeof bodyString !== 'string') {
            console.error('‚ùå Body no es un string:', typeof bodyString, bodyString);
            throw new Error('El body no es un string v√°lido');
          }

          const headers = new Headers();
          headers.set('Content-Type', 'application/json');
          headers.set('Accept', 'application/json');
          if (authToken) {
            headers.set('Authorization', 'Bearer ' + authToken);
          }
          
          console.log('üõí Checkout: Enviando request a /api/orders/create');
          console.log('üõí Checkout: Headers:', Object.fromEntries(headers.entries()));
          console.log('üõí Checkout: Body final (tipo):', typeof bodyString);
          console.log('üõí Checkout: Body final (valor):', bodyString);
          console.log('üõí Checkout: Body final (primeros 500 chars):', bodyString.substring(0, 500));
          
          const res = await fetch('/api/orders/create', {
            method: 'POST',
            headers: headers,
            body: bodyString,
            credentials: 'same-origin',
            cache: 'no-cache'
          });

          console.log('üõí Checkout: Respuesta recibida:', res.status, res.statusText);
          console.log('üõí Checkout: Content-Type:', res.headers.get('content-type'));

          // Leer la respuesta como texto primero
          const responseText = await res.text();
          console.log('üõí Checkout: Respuesta raw:', responseText.substring(0, 200));

          if (!res.ok) {
            console.error('‚ùå Error HTTP:', res.status, responseText);
            let errorData;
            try {
              errorData = JSON.parse(responseText);
            } catch (parseError) {
              console.error('‚ùå Error parseando respuesta de error:', parseError);
              errorData = { error: responseText || 'Error al crear el pedido' };
            }
            throw new Error(errorData.error || 'Error ' + res.status + ': ' + res.statusText);
          }

          // Parsear la respuesta exitosa
          let result;
          try {
            result = JSON.parse(responseText);
            console.log('üìã Checkout: Resultado parseado:', result);
          } catch (parseError) {
            console.error('‚ùå Error parseando respuesta exitosa:', parseError);
            console.error('‚ùå Respuesta que fall√≥:', responseText);
            throw new Error('Error al parsear la respuesta del servidor: ' + (parseError.message || 'Formato inv√°lido'));
          }

          if (!result.success || !result.order || !result.order.id) {
            console.error('‚ùå Respuesta inv√°lida:', result);
            throw new Error(result.error || 'Error al crear el pedido: respuesta inv√°lida');
          }

          const order = result.order;
          console.log('‚úÖ Checkout: Pedido creado:', order.id, 'Total:', order.total_amount);

          localStorage.removeItem(STORAGE_KEY);
          
          const orderIdParam = String(order.id);
          console.log('üîÑ Checkout: Redirigiendo a pago con orderId:', orderIdParam);
          window.location.href = '/pago?orderId=' + orderIdParam;
        } catch (err) {
          console.error('‚ùå Checkout: Error completo:', err);
          const errorMessage = err && err.message ? err.message : 'Ocurri√≥ un error al crear la orden. Intenta nuevamente o cont√°ctanos.';
          if (errorEl) errorEl.textContent = errorMessage;
          if (confirmBtn) {
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'Confirmar compra';
          }
        }
      });
    });
  </script>
</BaseLayout>
